<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åˆ‡åˆ†å·¥å…·A3è½¬A4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- 1. åŸºç¡€è®¾ç½® --- */
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg-main: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #334155;
            --text-sub: #64748b;
            --border: #cbd5e1;
        }

        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-main); 
            margin: 0; 
            padding: 15px; /* å‡å°‘å¤–è¾¹è· */
            height: 100vh; /* å¼ºåˆ¶å æ»¡ä¸€å± */
            overflow: hidden; /* ç¦æ­¢æ•´ä¸ªé¡µé¢æ»šåŠ¨ */
            display: flex;
            flex-direction: column;
            font-size: 15px; /* ä¿æŒå¤§å­—ä½“ */
        }

        /* é¡¶éƒ¨æ ‡é¢˜ - ç´§å‡‘ç‰ˆ */
        .header-section {
            text-align: center;
            margin-bottom: 15px; /* å‡å°‘é—´è· */
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
        }
        h1 { 
            margin: 0; font-size: 24px; color: var(--primary); 
            display: flex; align-items: center; justify-content: center; gap: 10px; 
        }
        .subtitle { 
            font-size: 14px; color: var(--text-sub); margin-top: 4px; 
            background: #e0e7ff; padding: 2px 12px; border-radius: 20px; display: inline-block;
        }

        /* --- 2. æ ¸å¿ƒå¸ƒå±€ (å…¨å±éæ»šåŠ¨) --- */
        .main-container {
            display: flex;
            gap: 20px; /* å‡å°‘å·¦å³é—´è· */
            width: 100%;
            max-width: 1300px;
            margin: 0 auto;
            flex: 1; /* å æ®æ ‡é¢˜ä¸‹æ–¹çš„æ‰€æœ‰ç©ºé—´ */
            min-height: 0; /* å…³é”®ï¼šå…è®¸å†…éƒ¨å­å…ƒç´ æ»šåŠ¨ */
        }

        /* å·¦ä¾§æ  */
        .left-panel {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%; /* æ’‘æ»¡é«˜åº¦ */
            overflow-y: auto; /* å¦‚æœå±å¹•å¤ªçŸ®ï¼Œå·¦ä¾§ä¹Ÿå¯ä»¥æ»šåŠ¨ */
        }

        /* å³ä¾§æ  */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%; /* æ’‘æ»¡é«˜åº¦ */
            min-width: 0;
        }

        /* é€šç”¨å¡ç‰‡ */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card-header {
            padding: 12px 20px; /* ç´§å‡‘å†…è¾¹è· */
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            font-weight: 700;
            color: var(--text-main);
            font-size: 16px;
            display: flex; align-items: center; gap: 8px;
            flex-shrink: 0;
        }
        
        .card-body { 
            padding: 15px 20px; 
            flex: 1; 
            display: flex; flex-direction: column; gap: 12px;
            overflow-y: auto; /* å†…å®¹è¿‡å¤šæ—¶æ»šåŠ¨ */
        }

        /* å·¦ä¾§ï¼šå‚æ•°è®¾ç½® */
        .settings-card { flex: 1; /* å æ®å·¦ä¾§å‰©ä½™ç©ºé—´ */ }
        
        .setting-item { margin-bottom: 15px; }
        .setting-item:last-child { margin-bottom: 0; }
        
        .label-row { 
            display: flex; justify-content: space-between; margin-bottom: 6px; 
            font-size: 15px; font-weight: 600; 
        }
        .input-row { display: flex; align-items: center; gap: 10px; }
        
        input[type="range"] { flex: 1; cursor: pointer; height: 6px; }
        input[type="number"] { 
            width: 55px; padding: 6px; border: 1px solid #cbd5e1; border-radius: 6px; 
            text-align: center; color: var(--primary); font-weight: bold; font-size: 14px;
        }
        .tip { 
            font-size: 13px; color: #94a3b8; margin-top: 6px; line-height: 1.4; 
            background: #f8fafc; padding: 6px; border-radius: 6px; 
        }

        /* å·¦ä¾§ï¼šæŒ‡å—åˆ—è¡¨ */
        .guide-list { margin: 0; padding-left: 18px; font-size: 14px; color: var(--text-sub); }
        .guide-list li { margin-bottom: 5px; }

        /* å³ä¾§ï¼šä¸Šä¼ åŒº (å›ºå®šé«˜åº¦) */
        .upload-box {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            height: 90px; /* å‹ä½é«˜åº¦ */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; background: #fcfcfc;
            flex-shrink: 0; /* ç¦æ­¢å‹ç¼© */
        }
        .upload-box:hover { border-color: var(--primary); background: #eef2ff; }
        .upload-text { font-weight: 600; font-size: 16px; color: var(--text-main); }
        .upload-sub { font-size: 13px; color: var(--text-sub); margin-top: 2px; }

        /* å³ä¾§ï¼šæ–‡ä»¶åˆ—è¡¨ (æ ¸å¿ƒï¼šå†…éƒ¨æ»šåŠ¨) */
        .file-list-wrapper {
            flex: 1;       /* å æ®ä¸­é—´æ‰€æœ‰ç©ºé—´ */
            min-height: 0; /* âš ï¸ å…³é”®ï¼šå…è®¸ Flex å­å…ƒç´ å°äºå†…å®¹é«˜åº¦ï¼Œä»è€Œè§¦å‘å†…éƒ¨æ»šåŠ¨ */
            display: flex; 
            flex-direction: column;
        }
        
        .file-list-container {
            flex: 1;          /* å¡«æ»¡ wrapper */
            overflow-y: auto; /* âš ï¸ å…³é”®ï¼šåªæœ‰è¿™ä¸ªåŒºåŸŸä¼šå‡ºç°æ»šåŠ¨æ¡ */
            background: #fff;
            min-height: 0;    /* ç¡®ä¿æ»šåŠ¨ç”Ÿæ•ˆ */
        }

        .file-list { padding: 0; margin: 0; list-style: none; }
        .file-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 20px; border-bottom: 1px solid #f1f5f9; font-size: 15px;
        }
        .file-item:hover { background: #f8fafc; }
        .file-name { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-del { 
            color: #ef4444; background: #fee2e2; border: none; cursor: pointer; 
            font-size: 13px; padding: 4px 10px; border-radius: 4px; 
        }

        /* å³ä¾§ï¼šåº•éƒ¨æ“ä½œåŒº (å›ºå®šé«˜åº¦) */
        .bottom-area {
            height: 160px; /* å‹ä½é«˜åº¦ï¼Œç•™æ›´å¤šç©ºé—´ç»™åˆ—è¡¨ */
            display: flex; gap: 15px;
            flex-shrink: 0; /* ç¦æ­¢å‹ç¼© */
        }
        .log-box {
            flex: 1; background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 12px;
            font-family: monospace; font-size: 13px; overflow-y: auto; line-height: 1.5;
            border: 1px solid #0f172a;
        }
        .btn-start {
            width: 150px; background: var(--primary); color: white; border: none; border-radius: 12px;
            cursor: pointer; font-size: 18px; font-weight: 600;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
            transition: 0.2s; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }
        .btn-start:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-start:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; transform: none; }

        /* --- 3. è‡ªé€‚åº”ï¼šå±å¹•å¤ªçŸ®æ—¶æ¢å¤é¡µé¢æ»šåŠ¨ --- */
        @media (max-height: 700px) {
            body { height: auto; overflow-y: auto; }
            .main-container { height: 800px; /* å¼ºåˆ¶ç»™ä¸ªé«˜åº¦ */ }
        }

        @media (max-width: 900px) {
            body { height: auto; overflow-y: auto; }
            .main-container { flex-direction: column; height: auto; }
            .left-panel, .right-panel { width: 100%; height: auto; }
            .file-list-wrapper { min-height: 300px; } /* ç§»åŠ¨ç«¯ç»™ä¸ªå›ºå®šé«˜åº¦ */
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .log-entry.success { color: #4ade80; }
        .log-entry.warn { color: #facc15; }
        .log-entry.error { color: #f87171; }
    </style>
</head>
<body>

    <div class="header-section">
        <h1>âœ‚ï¸ æ™ºèƒ½åˆ‡åˆ†å·¥å…·A3è½¬A4</h1>
        <div class="subtitle">A3 è¯•å·è½¬ A4 æ‰“å° Â· çº¯æœ¬åœ°å®‰å…¨å¤„ç†</div>
		<br>
		 <div class="subtitle">ä½œè€…ï¼šæ°¸æ’å› <a href="https://www.yhjbox.com" target="_blank" rel="noopener noreferrer">https://www.yhjbox.com</a></div>
    </div>

    <div class="main-container">
        
        <!-- å·¦ä¾§ -->
        <div class="left-panel">
            <div class="card">
                <div class="card-header">ğŸ’¡ ä½¿ç”¨è¯´æ˜</div>
                <div class="card-body" style="flex: 0 auto;">
                    <ol class="guide-list">
                        <li>ç‚¹å‡»è™šçº¿æ¡†é€‰æ‹© PDF (æ”¯æŒå¤šé€‰)ã€‚</li>
                        <li>æ–‡ä»¶åˆ—è¡¨å¯æ»šåŠ¨æŸ¥çœ‹ï¼Œæœ‰è¯¯é€‰å¯â€œåˆ é™¤â€ã€‚</li>
                        <li>è°ƒæ•´ä¸‹æ–¹å‚æ•°ï¼ˆé€šå¸¸ä½¿ç”¨é»˜è®¤å€¼å³å¯ï¼‰ã€‚</li>
						<li>ç‚¹å‡»â€œå¼€å§‹å¤„ç†â€ï¼Œå®Œæˆåä¼šè‡ªåŠ¨ä¸‹è½½ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç»“æœçš„ ZIP å‹ç¼©åŒ…ã€‚</li>
                    </ol>
                </div>
            </div>

            <div class="card settings-card">
                <div class="card-header">âš™ï¸ ç®—æ³•å‚æ•°</div>
                <div class="card-body">
                    
                    <div class="setting-item">
                        <div class="label-row">1. å»æ°´å°/èƒŒæ™¯è¿‡æ»¤</div>
                        <div class="input-row">
                            <span style="font-size:13px">æ·±</span>
                            <input type="range" id="thresholdRange" min="150" max="250" value="220" oninput="syncVal('thresholdNum', this.value)">
                            <span style="font-size:13px">æµ…</span>
                            <input type="number" id="thresholdNum" value="220" min="150" max="250" onchange="syncVal('thresholdRange', this.value)">
                        </div>
                        <div class="tip">é»˜è®¤ 220ã€‚æ°´å°é¢œè‰²è¶Šæ·±ï¼Œæ­¤æ•°å€¼è¶Šè¦è°ƒä½ã€‚</div>
                    </div>

                    <div class="setting-item">
                        <div class="label-row">2. ä¸­ç¼æœç´¢èŒƒå›´ (%)</div>
                        <div class="input-row">
                            <input type="number" id="scanMin" value="30">
                            <span>-</span>
                            <input type="number" id="scanMax" value="70">
                        </div>
                        <div class="tip">åªåœ¨æ­¤èŒƒå›´å†…å¯»æ‰¾ä¸­ç¼ï¼Œé¿å¼€è¾¹ç¼˜ç¬”è®°ã€‚</div>
                    </div>

                    <div class="setting-item">
                        <div class="label-row">3. ä¸Šä¸‹å¿½ç•¥èŒƒå›´ (%)</div>
                        <div class="input-row">
                            <span style="font-size:13px">é¡¶</span> <input type="number" id="ignoreTop" value="15">
                            <span style="font-size:13px">åº•</span> <input type="number" id="ignoreBottom" value="15">
                        </div>
                        <div class="tip">å¿½ç•¥é¡µçœ‰å’Œé¡µè„šï¼Œé˜²æ­¢å¹²æ‰°ã€‚</div>
                    </div>

                </div>
            </div>
        </div>

        <!-- å³ä¾§ -->
        <div class="right-panel">
            
            <!-- 1. ä¸Šä¼  (å›ºå®š) -->
            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                <div class="upload-text">ğŸ“‚ ç‚¹å‡»é€‰æ‹© PDF æ–‡ä»¶</div>
                <div class="upload-sub">æ”¯æŒæ‹–æ‹½ä¸Šä¼  / æ‰¹é‡é€‰æ‹©</div>
                <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;">
            </div>

            <!-- 2. åˆ—è¡¨ (å¼¹æ€§ä¼¸ç¼©ï¼Œå†…éƒ¨æ»šåŠ¨) -->
            <div class="card file-list-wrapper">
                <div class="card-header">
                    <span>å¾…å¤„ç†åˆ—è¡¨</span>
                    <span style="font-size:14px; color:var(--text-sub); font-weight:normal;" id="totalCount">0 ä¸ªæ–‡ä»¶</span>
                </div>
                <!-- æ»šåŠ¨åŒºåŸŸ -->
                <div class="file-list-container">
                    <ul class="file-list" id="fileList">
                        <li style="padding: 40px 0; text-align: center; color: #cbd5e1; display: flex; flex-direction: column; gap: 10px;">
                            <span style="font-size: 28px;">ğŸ“­</span>
                            <span>åˆ—è¡¨ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ æ–‡ä»¶</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 3. åº•éƒ¨ (å›ºå®š) -->
            <div class="bottom-area">
                <div class="log-box" id="logArea">
                    <div class="log-entry">--- ç­‰å¾…ä»»åŠ¡ ---</div>
                </div>
                <button id="startBtn" class="btn-start" disabled>
                    <span style="font-size: 24px;">â–¶</span>
                    <span>å¼€å§‹å¤„ç†</span>
                </button>
            </div>
        </div>

    </div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const fileInput = document.getElementById('fileInput');
    const fileListEl = document.getElementById('fileList');
    const totalCountEl = document.getElementById('totalCount');
    const startBtn = document.getElementById('startBtn');
    const logArea = document.getElementById('logArea');
    let fileQueue = [];

    window.syncVal = (id, val) => { document.getElementById(id).value = val; };

    function log(msg, type = '') {
        const div = document.createElement('div');
        div.className = `log-entry ${type}`;
        div.textContent = `> ${msg}`;
        logArea.appendChild(div);
        logArea.scrollTop = logArea.scrollHeight;
    }

    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    const dropZone = document.querySelector('.upload-box');
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.backgroundColor = '#eef2ff'; dropZone.style.borderColor = 'var(--primary)'; });
    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.backgroundColor = '#fcfcfc'; dropZone.style.borderColor = '#cbd5e1'; });
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.style.backgroundColor = '#fcfcfc'; dropZone.style.borderColor = '#cbd5e1'; handleFiles(e.dataTransfer.files); });

    function handleFiles(files) {
        const newFiles = Array.from(files).filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));
        if(newFiles.length === 0) return;
        newFiles.forEach(f => {
            if(!fileQueue.some(ex => ex.name === f.name && ex.size === f.size)) fileQueue.push(f);
        });
        renderList();
        fileInput.value = '';
    }

    function renderList() {
        totalCountEl.textContent = `${fileQueue.length} ä¸ªæ–‡ä»¶`;
        startBtn.disabled = fileQueue.length === 0;
        if(fileQueue.length === 0) {
            fileListEl.innerHTML = `<li style="padding: 40px 0; text-align: center; color: #cbd5e1; display: flex; flex-direction: column; gap: 10px;"><span style="font-size: 28px;">ğŸ“­</span><span>åˆ—è¡¨ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ æ–‡ä»¶</span></li>`;
            return;
        }
        fileListEl.innerHTML = '';
        fileQueue.forEach((file, idx) => {
            const li = document.createElement('li');
            li.className = 'file-item';
            li.innerHTML = `<span class="file-name" title="${file.name}">ğŸ“„ ${file.name}</span><button class="btn-del" onclick="removeFile(${idx})">åˆ é™¤</button>`;
            fileListEl.appendChild(li);
        });
    }

    window.removeFile = (idx) => { fileQueue.splice(idx, 1); renderList(); };

    startBtn.addEventListener('click', async () => {
        if(fileQueue.length === 0) return;
        startBtn.disabled = true;
        startBtn.innerHTML = '<span style="font-size: 20px;">â³</span><span>å¤„ç†ä¸­...</span>';
        log('--- å¼€å§‹æ‰¹é‡å¤„ç† ---');

        const config = {
            threshold: parseInt(document.getElementById('thresholdNum').value),
            scanMin: parseInt(document.getElementById('scanMin').value) / 100,
            scanMax: parseInt(document.getElementById('scanMax').value) / 100,
            ignoreTop: parseInt(document.getElementById('ignoreTop').value) / 100,
            ignoreBottom: parseInt(document.getElementById('ignoreBottom').value) / 100
        };

        const zip = new JSZip();
        let successCount = 0;

        try {
            for (let i = 0; i < fileQueue.length; i++) {
                const file = fileQueue[i];
                log(`æ­£åœ¨åˆ†æ: ${file.name}`);
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                    const newPdfDoc = await PDFLib.PDFDocument.create();
                    const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
                    const pdfAnalysis = await loadingTask.promise;
                    const pageCount = pdfDoc.getPageCount();

                    for (let p = 0; p < pageCount; p++) {
                        const page = await pdfAnalysis.getPage(p + 1);
                        const viewport = page.getViewport({scale: 0.5});
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        await page.render({canvasContext: ctx, viewport: viewport}).promise;
                        
                        const splitRatio = findSplitRatio(ctx, canvas.width, canvas.height, config);
                        
                        const [orig] = await newPdfDoc.copyPages(pdfDoc, [p]);
                        const { width, height } = orig.getSize();
                        const splitX = width * splitRatio;

                        const leftP = await newPdfDoc.addPage(orig);
                        leftP.setCropBox(0, 0, splitX, height);
                        const [rightRaw] = await newPdfDoc.copyPages(pdfDoc, [p]);
                        const rightP = await newPdfDoc.addPage(rightRaw);
                        rightP.setCropBox(splitX, 0, width - splitX, height);
                    }
                    const newBytes = await newPdfDoc.save();
                    zip.file(file.name.replace(/\.pdf$/i, '') + '_A4ç‰ˆ.pdf', newBytes);
                    successCount++;
                    log(`âœ… å®Œæˆ`, 'success');
                } catch (err) {
                    log(`âŒ å¤±è´¥: ${err.message}`, 'error');
                }
            }
            if(successCount > 0) {
                log(`æ­£åœ¨æ‰“åŒ…...`, 'success');
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, "A3æ™ºèƒ½åˆ‡åˆ†A4ç»“æœ.zip");
            }
        } catch (e) { log(`é”™è¯¯: ${e.message}`, 'error'); } 
        finally {
            startBtn.disabled = false;
            startBtn.innerHTML = '<span style="font-size: 24px;">â–¶</span><span>å¼€å§‹å¤„ç†</span>';
            log('--- ç»“æŸ ---');
        }
    });

    function findSplitRatio(ctx, width, height, cfg) {
        const data = ctx.getImageData(0, 0, width, height).data;
        const xStart = Math.floor(width * cfg.scanMin);
        const xEnd = Math.floor(width * cfg.scanMax);
        const yStart = Math.floor(height * cfg.ignoreTop);
        const yEnd = Math.floor(height * (1 - cfg.ignoreBottom));
        
        const gaps = [];
        for(let x=xStart; x<xEnd; x++) {
            let white = 0, total = 0;
            for(let y=yStart; y<yEnd; y++) {
                const i = (y * width + x) * 4;
                if (((data[i]+data[i+1]+data[i+2])/3) > cfg.threshold) white++;
                total++;
            }
            gaps.push((white/total) > 0.98);
        }

        let maxLen=0, maxStart=0, curStart=-1;
        for(let i=0; i<gaps.length; i++) {
            if(gaps[i]) { if(curStart===-1) curStart=i; }
            else if(curStart!==-1) {
                if(i-curStart > maxLen) { maxLen=i-curStart; maxStart=curStart; }
                curStart=-1;
            }
        }
        if(curStart!==-1 && gaps.length-curStart > maxLen) { maxLen = gaps.length-curStart; maxStart=curStart; }
        return maxLen===0 ? 0.5 : (xStart + maxStart + maxLen/2) / width;
    }
</script>
</body>
</html>