---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/sections/Footer.astro';
import Header from '../components/sections/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
---

<!doctype html>
<html lang="zh-CN" data-theme="dark" class="dark">
	<head>
		<BaseHead title={`Split PDF A3 to A4: Cut Pages in Half Vertically Online (Free)`} description="Easily split A3 PDF pages into two A4 pages online. Use our free tool to cut PDF pages in half vertically down the middle. No registration, no watermarks." />
	</head>
	<body>
		<!-- SVG å›¾æ ‡å®šä¹‰é›† (Sprite System) -->
		<!-- é¢„å®šä¹‰å›¾æ ‡ä»¥å¤ç”¨ä»£ç ï¼Œå‡å°‘HTMLä½“ç§¯ï¼Œæå‡å¯ç»´æŠ¤æ€§ -->
		<svg style="display: none;" aria-hidden="true">
			<symbol id="icon-upload" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
			</symbol>
			<symbol id="icon-plus" viewBox="0 0 20 20" fill="currentColor">
				<path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
			</symbol>
			<symbol id="icon-book" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18-3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
			</symbol>
			<symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
			</symbol>
			<symbol id="icon-logs" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z" />
			</symbol>
			<symbol id="icon-play" viewBox="0 0 20 20" fill="currentColor">
				<path d="M10 2a.75.75 0 0 1 .75.75v12.59l1.95-2.1a.75.75 0 1 1 1.1 1.02l-3.25 3.5a.75.75 0 0 0-1.1 0l-3.25-3.5a.75.75 0 1 1 1.1-1.02l1.95 2.1V2.75A.75.75 0 0 1 10 2Z" />
			</symbol>
			<symbol id="icon-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
			</symbol>
			<symbol id="icon-file" viewBox="0 0 20 20" fill="currentColor">
				<path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 0 0 3 3.5v13A1.5 1.5 0 0 0 4.5 18h11a1.5 1.5 0 0 0 1.5-1.5V7.621a1.5 1.5 0 0 0-.44-1.06l-4.12-4.122A1.5 1.5 0 0 0 11.378 2H4.5Zm2.25 8.5a.75.75 0 0 0 0 1.5h6.5a.75.75 0 0 0 0-1.5h-6.5Zm0 3a.75.75 0 0 0 0 1.5h6.5a.75.75 0 0 0 0-1.5h-6.5Z" clip-rule="evenodd" />
			</symbol>
			<symbol id="icon-trash" viewBox="0 0 20 20" fill="currentColor">
				<path d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z" />
			</symbol>
			<symbol id="icon-spinner" viewBox="0 0 24 24" fill="none">
				<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
				<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
			</symbol>
		</svg>

		<Header />
		<main>
			<section class="py-1 px-4">
				<div class="max-w-4xl mx-auto">
					<h1 class="text-3xl md:text-4xl font-bold text-center mb-8">A3 to 2 x A4 Splitter</h1>
					<div class="card-surface p-8">
				
				<!-- ä¸Šä¼ åŒºåŸŸ -->
				<div id="uploadSection" class="w-full transition-all duration-300 mb-6">
					<div id="dropZone" role="button" tabindex="0" aria-label="ç‚¹å‡»æˆ–æ‹–æ”¾ä¸Šä¼ PDF" class="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-10 cursor-pointer hover:border-primary dark:hover:border-primary hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all duration-200 group flex flex-col items-center justify-center min-h-[280px]">
						<div class="w-20 h-20 bg-primary/10 text-primary rounded-full flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-200">
							<svg class="w-10 h-10"><use href="#icon-upload"></use></svg>
						</div>
						<h3 class="font-semibold text-xl mb-3">Click or drag to upload PDF</h3>
						<p class="text-gray-500 text-base max-w-sm text-center leading-relaxed">
							 Multiple files Supported
						</p>
						<input type="file" id="fileInput" multiple accept=".pdf" class="hidden">
					</div>
				</div>
				
				<!-- æ–‡ä»¶åˆ—è¡¨åŒºåŸŸ -->
				<div id="filesSection" class="w-full hidden" aria-live="polite">
					<div class="flex flex-col border border-gray-300 dark:border-gray-700 rounded-lg">
						<!-- åˆ—è¡¨å¤´éƒ¨ -->
						<div class="flex justify-between items-center px-5 py-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 rounded-t-lg">
							<div class="flex items-center gap-2">
								<span class="flex h-2 w-2 rounded-full bg-green-500"></span>
								<h5 class="font-medium text-sm">Pending Files</h5>
							</div>
							<div class="flex items-center gap-3">
								<span id="fileCount" class="text-gray-500 text-xs font-mono bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded">0</span>
								<button id="clearBtn" aria-label="Clear" class="text-xs text-red-500 hover:text-red-600 transition-colors flex items-center gap-1 cursor-pointer">
									Clear
								</button>
							</div>
						</div>
						
						<!-- æ–‡ä»¶åˆ—è¡¨å®¹å™¨ -->
						<div id="fileListContainer" class="max-h-[180px] overflow-y-auto custom-scrollbar p-3 space-y-2 bg-white dark:bg-gray-800/30">
							<ul id="fileList" class="space-y-2">
								<!-- JSå°†åœ¨è¿™é‡Œæ³¨å…¥å†…å®¹ -->
							</ul>
						</div>
						
						<!-- åº•éƒ¨æ“ä½œæ  -->
						<button id="addMore" class="w-full p-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/30 rounded-b-lg flex justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors group">
							<span class="text-primary text-sm font-medium flex items-center gap-2">
								<svg class="w-4 h-4"><use href="#icon-plus"></use></svg>
								ç»§ç»­æ·»åŠ æ–‡ä»¶
							</span>
						</button>
					</div>
				</div>
			</div>
			
			<!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
			<div class="w-full max-w-4xl mt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
				<div class="flex gap-6 w-full sm:w-auto">
					<button id="helpBtn" aria-haspopup="dialog" class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-6 py-3 bg-gray-100 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-700 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white transition-colors">
						<svg class="w-4 h-4"><use href="#icon-book"></use></svg>
						Instructions
					</button>
					<button id="settingsBtn" aria-haspopup="dialog" class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-6 py-3 bg-gray-100 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-700 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white transition-colors">
						<svg class="w-4 h-4"><use href="#icon-settings"></use></svg>
						Settings
					</button>
					<button id="logsBtn" aria-haspopup="dialog" class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-6 py-3 bg-gray-100 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-700 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white transition-colors">
						<svg class="w-4 h-4"><use href="#icon-logs"></use></svg>
						Logs
					</button>
				</div>
				
				<button id="startBtn" class="w-full sm:w-auto flex-1 flex items-center justify-center gap-2 px-10 py-3 bg-primary text-white rounded-lg text-sm font-bold hover:bg-primary/90 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors shadow-lg shadow-primary/20">
					<svg class="w-4 h-4"><use href="#icon-play"></use></svg>
					Start
				</button>
			</div>
		</div>
		</main>
		
		<!-- æ¨¡æ€æ¡†èƒŒæ™¯ -->
		<div id="modalOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden items-center justify-center transition-opacity duration-300 opacity-0" aria-hidden="true">
			
			<!-- è®¾ç½®æ¨¡æ€æ¡† -->
			<div id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 hidden transform transition-all duration-300 scale-95 border border-slate-200 dark:border-slate-700 modal-content">
				<div class="flex justify-between items-center mb-6">
					<h2 id="settingsTitle" class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
						<span class="text-indigo-500">âš™ï¸</span> Settings
					</h2>
					<button class="close-modal-btn text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-primary">
						<svg class="w-5 h-5"><use href="#icon-close"></use></svg>
					</button>
				</div>
				<div class="space-y-6">
					<!-- æ°´å°é˜ˆå€¼ -->
					<div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl">
						<div class="flex justify-between items-center mb-3">
							<label class="font-medium text-slate-700 dark:text-slate-300 text-sm">æ°´å°è¿‡æ»¤é˜ˆå€¼</label>
							<input type="number" id="thresholdNum" value="220" min="150" max="250" class="w-16 p-1 px-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-center text-sm font-mono focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none">
						</div>
						<input type="range" id="thresholdRange" min="150" max="250" value="220" class="w-full h-1.5 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb">
						<p class="text-slate-400 text-xs mt-2">æ°´å°é¢œè‰²è¶Šæ·±ï¼Œæ­¤æ•°å€¼è¶Šè¦è°ƒä½ã€‚æ•°å€¼è¶Šä½è¿‡æ»¤è¶Šå¼ºï¼Œä½†å¯èƒ½è¯¯ä¼¤æ–‡å­—ã€‚</p>
					</div>
					
					<!-- åˆ†å‰²èŒƒå›´ -->
					<div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl">
						<label class="font-medium text-slate-700 dark:text-slate-300 block mb-3 text-sm">ä¸­ç¼æœç´¢èŒƒå›´ (%)</label>
						<div class="flex items-center gap-3">
							<input type="number" id="scanMin" value="30" min="0" max="100" aria-label="æœç´¢èµ·å§‹ç™¾åˆ†æ¯”" class="flex-1 p-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-center text-sm font-mono focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none">
							<span class="text-slate-400 text-xs">è‡³</span>
							<input type="number" id="scanMax" value="70" min="0" max="100" aria-label="æœç´¢ç»“æŸç™¾åˆ†æ¯”" class="flex-1 p-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-center text-sm font-mono focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none">
						</div>
						<p class="text-slate-400 text-xs mt-2">åªåœ¨æ­¤èŒƒå›´å†…å¯»æ‰¾ä¸­ç¼ï¼Œé¿å¼€è¾¹ç¼˜ç¬”è®°ã€‚</p>
					</div>
					
					<!-- å¿½ç•¥èŒƒå›´ -->
					<div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl">
						<label class="font-medium text-slate-700 dark:text-slate-300 block mb-3 text-sm">ä¸Šä¸‹å¿½ç•¥èŒƒå›´ (%)</label>
						<div class="grid grid-cols-2 gap-3">
							<div>
								<label class="text-slate-400 text-xs block mb-1">é¡¶éƒ¨å¿½ç•¥</label>
								<input type="number" id="ignoreTop" value="15" min="0" max="100" class="w-full p-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-center text-sm font-mono focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none">
							</div>
							<div>
								<label class="text-slate-400 text-xs block mb-1">åº•éƒ¨å¿½ç•¥</label>
								<input type="number" id="ignoreBottom" value="15" min="0" max="100" class="w-full p-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-center text-sm font-mono focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none">
							</div>
							<p class="text-slate-400 text-xs mt-2">å¿½ç•¥é¡µçœ‰å’Œé¡µè„šï¼Œé˜²æ­¢å¹²æ‰°ã€‚</p>
						</div>
					</div>
				</div>
			</div>
			
			<!-- ä½¿ç”¨è¯´æ˜æ¨¡æ€æ¡† -->
			<div id="helpModal" role="dialog" aria-modal="true" aria-labelledby="helpTitle" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 hidden transform transition-all duration-300 scale-95 border border-slate-200 dark:border-slate-700 modal-content">
				<div class="flex justify-between items-center mb-6">
					<h2 id="helpTitle" class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
						<span class="text-indigo-500">ğŸ“–</span> ä½¿ç”¨è¯´æ˜
					</h2>
					<button class="close-modal-btn text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-primary">
						<svg class="w-5 h-5"><use href="#icon-close"></use></svg>
					</button>
				</div>
				<div class="space-y-4">
					<div class="flex gap-4 items-start p-3 rounded-lg bg-slate-50 dark:bg-slate-900/50">
						<span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-400 font-bold text-sm flex items-center justify-center mt-0.5">1</span>
						<p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">ç‚¹å‡»ä¸Šä¼ åŒºåŸŸæˆ–ç›´æ¥å°† PDF æ–‡ä»¶æ‹–å…¥æ¡†å†…ï¼ˆæ”¯æŒå¤šé€‰ï¼‰ã€‚</p>
					</div>
					<div class="flex gap-4 items-start p-3 rounded-lg bg-slate-50 dark:bg-slate-900/50">
						<span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-400 font-bold text-sm flex items-center justify-center mt-0.5">2</span>
						<p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">åœ¨æ–‡ä»¶åˆ—è¡¨ä¸­ç¡®è®¤æ–‡ä»¶ï¼Œå¦‚æœ‰éœ€è¦å¯åœ¨"è®¾ç½®"ä¸­è°ƒæ•´åˆ‡åˆ†å‚æ•°ã€‚</p>
					</div>
					<div class="flex gap-4 items-start p-3 rounded-lg bg-slate-50 dark:bg-slate-900/50">
						<span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-400 font-bold text-sm flex items-center justify-center mt-0.5">3</span>
						<p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">ç‚¹å‡»"å¼€å§‹å¤„ç†"ï¼Œå®Œæˆåä¼šè‡ªåŠ¨ä¸‹è½½å¤„ç†å¥½çš„ ZIP å‹ç¼©åŒ…ã€‚</p>
					</div>
				</div>
			</div>
			
			<!-- å¤„ç†æ—¥å¿—æ¨¡æ€æ¡† -->
			<div id="logsModal" role="dialog" aria-modal="true" aria-labelledby="logsTitle" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 hidden transform transition-all duration-300 scale-95 border border-slate-200 dark:border-slate-700 modal-content">
				<div class="flex justify-between items-center mb-4">
					<h2 id="logsTitle" class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
						<span class="text-indigo-500">ğŸ“‹</span> å¤„ç†æ—¥å¿—
					</h2>
					<button class="close-modal-btn text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-primary">
						<svg class="w-5 h-5"><use href="#icon-close"></use></svg>
					</button>
				</div>
				<div class="bg-slate-950 text-slate-200 rounded-xl p-4 h-[300px] overflow-y-auto font-mono text-xs leading-relaxed border border-slate-800 shadow-inner" id="logArea">
					<div class="text-slate-500 italic mb-2"># Ready...</div>
				</div>
			</div>
		</div>
		
		<Footer />
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
		<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
		
		<script>
			// ç­‰å¾… DOM å®Œå…¨åŠ è½½åæ‰§è¡Œ
			window.addEventListener('DOMContentLoaded', function() {
				// ä¾èµ–åº“æ£€æŸ¥
				if (typeof pdfjsLib !== 'undefined') {
					pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
				} else {
					console.error('PDF.js åº“æœªèƒ½æ­£ç¡®åŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
					return;
				}

				// DOM å…ƒç´ å¼•ç”¨ç¼“å­˜
				const elements = {
					fileInput: document.getElementById('fileInput'),
					fileList: document.getElementById('fileList'),
					fileCount: document.getElementById('fileCount'),
					startBtn: document.getElementById('startBtn'),
					clearBtn: document.getElementById('clearBtn'),
					addMoreBtn: document.getElementById('addMore'),
					logArea: document.getElementById('logArea'),
					dropZone: document.getElementById('dropZone'),
					uploadSection: document.getElementById('uploadSection'),
					filesSection: document.getElementById('filesSection'),
					modalOverlay: document.getElementById('modalOverlay'),
					fileListContainer: document.getElementById('fileListContainer'),
					// è®¾ç½®é¡¹è¾“å…¥æ¡†
					thresholdNum: document.getElementById('thresholdNum'),
					thresholdRange: document.getElementById('thresholdRange'),
					scanMin: document.getElementById('scanMin'),
					scanMax: document.getElementById('scanMax'),
					ignoreTop: document.getElementById('ignoreTop'),
					ignoreBottom: document.getElementById('ignoreBottom')
				};

				// æ¨¡æ€æ¡†æ˜ å°„è¡¨
				const modalMap = {
					'settingsBtn': document.getElementById('settingsModal'),
					'helpBtn': document.getElementById('helpModal'),
					'logsBtn': document.getElementById('logsModal')
				};

				let fileQueue = []; // å¾…å¤„ç†æ–‡ä»¶é˜Ÿåˆ—
				let lastFocusedElement = null; // ç”¨äºæ¨¡æ€æ¡†å…³é—­åæ¢å¤ç„¦ç‚¹

				// åŒæ­¥æ»‘å—å’Œæ•°å­—è¾“å…¥æ¡†çš„å€¼
				function syncInputValues(targetId, val) {
					document.getElementById(targetId).value = val;
				}
				
				elements.thresholdNum.addEventListener('change', e => syncInputValues('thresholdRange', e.target.value));
				elements.thresholdRange.addEventListener('input', e => syncInputValues('thresholdNum', e.target.value));

				// æ—¥å¿—è¾“å‡ºå‡½æ•°
				function log(msg, type = 'info') {
					const div = document.createElement('div');
					div.className = `log-entry py-1 border-b border-slate-800/50 ${type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-slate-300'}`;
					const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
					div.innerHTML = `<span class="opacity-50 mr-2">[${time}]</span>${msg}`;
					elements.logArea.appendChild(div);
					elements.logArea.scrollTop = elements.logArea.scrollHeight;
				}

				// åˆ‡æ¢ä¸»ç•Œé¢æ˜¾ç¤ºçŠ¶æ€ï¼ˆä¸Šä¼ é¡µ/åˆ—è¡¨é¡µï¼‰
				function toggleMainContent(hasFiles) {
					if (hasFiles) {
						elements.uploadSection.classList.add('hidden');
						elements.filesSection.classList.remove('hidden');
					} else {
						elements.uploadSection.classList.remove('hidden');
						elements.filesSection.classList.add('hidden');
					}
				}

				// --- æ— éšœç¢æ¨¡æ€æ¡†é€»è¾‘ ---
				
				function openModal(modalId) {
					const modal = modalMap[modalId] || (typeof modalId === 'string' ? document.getElementById(modalId) : modalId);
					if (!modal) return;
					
					lastFocusedElement = document.activeElement;
					
					elements.modalOverlay.classList.remove('hidden');
					elements.modalOverlay.style.display = 'flex';
					void elements.modalOverlay.offsetWidth; // è§¦å‘é‡ç»˜
					elements.modalOverlay.classList.remove('opacity-0');
					
					modal.classList.remove('hidden');
					modal.style.display = 'block';
					setTimeout(() => {
						modal.classList.remove('scale-95');
						modal.classList.add('scale-100');
						// ç„¦ç‚¹æ•è·ï¼šå°†ç„¦ç‚¹ç§»è‡³æ¨¡æ€æ¡†å†…ç¬¬ä¸€ä¸ªå¯äº¤äº’å…ƒç´ 
						const focusableContent = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
						if (focusableContent.length) {
							focusableContent[0].focus();
						}
					}, 10);
				}

				function closeModal(modal) {
					if (!modal) return;
					modal.classList.remove('scale-100');
					modal.classList.add('scale-95');
					elements.modalOverlay.classList.add('opacity-0');
					
					setTimeout(() => {
						modal.classList.add('hidden');
						modal.style.display = 'none';
						elements.modalOverlay.classList.add('hidden');
						elements.modalOverlay.style.display = 'none';
						if (lastFocusedElement) lastFocusedElement.focus();
					}, 300);
				}

				// ç»‘å®šæ¨¡æ€æ¡†è§¦å‘æŒ‰é’®äº‹ä»¶
				Object.keys(modalMap).forEach(btnId => {
					document.getElementById(btnId).addEventListener('click', () => openModal(btnId));
				});

				// ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
				document.querySelectorAll('.close-modal-btn').forEach(btn => {
					btn.addEventListener('click', (e) => {
						const modal = e.target.closest('.modal-content');
						closeModal(modal);
					});
				});

				// ç‚¹å‡»é®ç½©å±‚å…³é—­
				elements.modalOverlay.addEventListener('click', (e) => {
					if (e.target === elements.modalOverlay) {
						document.querySelectorAll('.modal-content:not(.hidden)').forEach(closeModal);
					}
				});

				// ESC é”®å…³é—­
				document.addEventListener('keydown', (e) => {
					if (e.key === 'Escape') {
						document.querySelectorAll('.modal-content:not(.hidden)').forEach(closeModal);
					}
				});

				// --- æ–‡ä»¶å¤„ç†é€»è¾‘ ---

				function handleFiles(files) {
					const newFiles = Array.from(files).filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));
					if(newFiles.length === 0) {
						if(files.length > 0) log('è¯·é€‰æ‹© PDF æ–‡ä»¶', 'error');
						return;
					}
					
					newFiles.forEach(f => {
						// é¿å…é‡å¤æ·»åŠ å®Œå…¨ç›¸åŒçš„æ–‡ä»¶
						if(!fileQueue.some(ex => ex.name === f.name && ex.size === f.size)) {
							fileQueue.push(f);
						}
					});
					
					renderFileList();
					
					if (fileQueue.length > 0) {
						toggleMainContent(true);
					}
				}

				function renderFileList() {
					elements.fileCount.textContent = `${fileQueue.length}`;
					
					if (fileQueue.length === 0) {
						elements.fileList.innerHTML = '';
						return;
					}
					
					// ä½¿ç”¨ data å±æ€§ä»£æ›¿ onclickï¼Œé¿å…å†…è” JS
					elements.fileList.innerHTML = fileQueue.map((file, idx) => `
						<li class="group bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-2.5 shadow-sm hover:shadow-md transition-all duration-200 flex items-center justify-between gap-3 animate-fadeIn">
							<div class="flex items-center gap-3 overflow-hidden">
								<div class="w-9 h-9 rounded-lg bg-rose-50 dark:bg-rose-900/30 text-rose-500 dark:text-rose-400 flex items-center justify-center flex-shrink-0">
									<svg class="w-4 h-4"><use href="#icon-file"></use></svg>
								</div>
								<div class="min-w-0">
									<div class="font-medium text-slate-700 dark:text-slate-200 text-sm truncate" title="${file.name}">${file.name}</div>
									<div class="text-slate-400 dark:text-slate-500 text-xs flex items-center gap-2">
										<span>${(file.size / 1024 / 1024).toFixed(2)} MB</span>
										<span class="w-1 h-1 rounded-full bg-slate-300 dark:bg-slate-600"></span>
										<span class="text-indigo-500">ç­‰å¾…å¤„ç†</span>
									</div>
								</div>
							</div>
							<button data-action="remove" data-index="${idx}" aria-label="ç§»é™¤ ${file.name}" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
								<svg class="w-4 h-4 pointer-events-none"><use href="#icon-trash"></use></svg>
							</button>
						</li>
					`).join('');
					
					elements.fileListContainer.scrollTop = elements.fileListContainer.scrollHeight;
				}

				// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ–‡ä»¶ç§»é™¤ï¼Œæ›¿ä»£ window.removeFile
				elements.fileList.addEventListener('click', (e) => {
					const btn = e.target.closest('button[data-action="remove"]');
					if (btn) {
						const idx = parseInt(btn.dataset.index);
						fileQueue.splice(idx, 1);
						renderFileList();
						if (fileQueue.length === 0) {
							toggleMainContent(false);
						}
					}
				});

				elements.clearBtn.addEventListener('click', () => {
					if (fileQueue.length > 0) {
						fileQueue = [];
						renderFileList();
						log('File list clear', 'info');
						toggleMainContent(false);
					}
				});

				elements.addMoreBtn.addEventListener('click', () => elements.fileInput.click());
				
				elements.fileInput.addEventListener('change', (e) => {
					handleFiles(e.target.files);
					elements.fileInput.value = '';
				});

				// æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
				['dragover', 'dragleave', 'drop'].forEach(eventName => {
					elements.dropZone.addEventListener(eventName, (e) => e.preventDefault());
				});

				elements.dropZone.addEventListener('dragover', () => elements.dropZone.classList.add('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/20'));
				elements.dropZone.addEventListener('dragleave', () => elements.dropZone.classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/20'));
				elements.dropZone.addEventListener('drop', (e) => {
					elements.dropZone.classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/20');
					handleFiles(e.dataTransfer.files);
				});
				elements.dropZone.addEventListener('click', () => elements.fileInput.click());
				
				// é”®ç›˜æ”¯æŒ
				elements.dropZone.addEventListener('keydown', (e) => {
					if(e.key === 'Enter' || e.key === ' ') {
						e.preventDefault();
						elements.fileInput.click();
					}
				});

				// --- æ ¸å¿ƒå¤„ç†é€»è¾‘ ---

				elements.startBtn.addEventListener('click', async () => {
					if (fileQueue.length === 0) return;
					
					// è·å–å½“å‰é…ç½®
					const config = {
						threshold: parseInt(elements.thresholdNum.value),
						scanMin: parseInt(elements.scanMin.value) / 100,
						scanMax: parseInt(elements.scanMax.value) / 100,
						ignoreTop: parseInt(elements.ignoreTop.value) / 100,
						ignoreBottom: parseInt(elements.ignoreBottom.value) / 100
					};
					
					// UI çŠ¶æ€æ›´æ–°
					elements.startBtn.disabled = true;
					elements.startBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"><use href="#icon-spinner"></use></svg>Processing...`;
					
					openModal('logsModal');
					
					try {
						await processFiles(fileQueue, config);
					} catch (e) {
						log(`é”™è¯¯: ${e.message}`, 'error');
					} finally {
						elements.startBtn.disabled = false;
						elements.startBtn.innerHTML = `<svg class="w-4 h-4 mr-2"><use href="#icon-play"></use></svg>Start`;
					}
				});

				/**
				 * è®¡ç®—ä¸­ç¼ä½ç½®æ¯”ä¾‹
				 * @param {CanvasRenderingContext2D} ctx - Canvas ä¸Šä¸‹æ–‡
				 * @param {number} width - é¡µé¢å®½åº¦
				 * @param {number} height - é¡µé¢é«˜åº¦
				 * @param {Object} cfg - é…ç½®å¯¹è±¡
				 */
				function findSplitRatio(ctx, width, height, cfg) {
					// æç¤ºï¼šwillReadFrequently å±æ€§åœ¨åˆ›å»º Context æ—¶å·²è®¾ç½®ï¼Œæ­¤å¤„ç›´æ¥è°ƒç”¨
					const data = ctx.getImageData(0, 0, width, height).data;
					const xStart = Math.floor(width * cfg.scanMin);
					const xEnd = Math.floor(width * cfg.scanMax);
					const yStart = Math.floor(height * cfg.ignoreTop);
					const yEnd = Math.floor(height * (1 - cfg.ignoreBottom));
					
					const checkRange = xEnd - xStart;
					const gaps = new Uint8Array(checkRange);
					
					// é€åˆ—æ‰«æç™½è‰²åƒç´ æ¯”ä¾‹
					for(let x = 0; x < checkRange; x++) {
						const currentX = xStart + x;
						let white = 0, total = 0;
						for(let y = yStart; y < yEnd; y++) {
							const i = (y * width + currentX) * 4;
							// è®¡ç®— RGB å¹³å‡å€¼åˆ¤æ–­æ˜¯å¦ä¸ºç™½è‰²
							if (((data[i] + data[i+1] + data[i+2]) / 3) > cfg.threshold) white++;
							total++;
						}
						// å¦‚æœä¸€åˆ—ä¸­ 98% ä»¥ä¸Šæ˜¯ç™½è‰²ï¼Œæ ‡è®°ä¸ºä¸­ç¼å€™é€‰
						if ((white / total) > 0.98) gaps[x] = 1; 
					}

					// å¯»æ‰¾æœ€é•¿è¿ç»­ç™½è‰²åŒºåŸŸ
					let maxLen = 0, maxStart = 0, curStart = -1;
					for(let i = 0; i < checkRange; i++) {
						if(gaps[i] === 1) { 
							if(curStart === -1) curStart = i; 
						}
						else if(curStart !== -1) {
							if(i - curStart > maxLen) { 
								maxLen = i - curStart; 
								maxStart = curStart; 
							}
							curStart = -1;
						}
					}
					// å¤„ç†è¾¹ç¼˜æƒ…å†µ
					if(curStart !== -1 && checkRange - curStart > maxLen) { 
						maxLen = checkRange - curStart; 
						maxStart = curStart; 
					}
					
					// æœªæ‰¾åˆ°åˆ™é»˜è®¤ä»ä¸­é—´åˆ‡åˆ†
					return maxLen === 0 ? 0.5 : (xStart + maxStart + maxLen/2) / width;
				}
				
				/**
				 * å¤„ç†æ–‡ä»¶é˜Ÿåˆ—
				 * ä¼˜åŒ–è¯´æ˜ï¼šä½¿ç”¨å•ä¾‹ Canvasï¼Œé¿å…å†…å­˜æ³„æ¼ï¼›åŠæ—¶é‡Šæ”¾ PDF èµ„æº
				 */
				async function processFiles(files, config) {
					log('å¼€å§‹å¤„ç†æ–‡ä»¶...', 'info');
					
					const zip = new JSZip();
					let successCount = 0;

					// åˆ›å»ºå…±äº« Canvasï¼Œå‡å°‘ DOM æ“ä½œå’Œå†…å­˜åˆ†é…
					const sharedCanvas = document.createElement('canvas');
					// willReadFrequently: true æç¤ºæµè§ˆå™¨ä¼˜åŒ– getImageData è¯»å–æ€§èƒ½
					const ctx = sharedCanvas.getContext('2d', { willReadFrequently: true });

					try {
						for (let i = 0; i < files.length; i++) {
							const file = files[i];
							log(`æ­£åœ¨åˆ†æ: ${file.name}`);
							let loadingTask = null;
							
							try {
								const arrayBuffer = await file.arrayBuffer();
								
								// 1. åŠ è½½ PDF æ–‡æ¡£ (pdf-lib)
								const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
								const newPdfDoc = await PDFLib.PDFDocument.create();
								
								// 2. åŠ è½½ PDF è§£æä»»åŠ¡ (pdf.js)
								loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
								const pdfAnalysis = await loadingTask.promise;
								const pageCount = pdfDoc.getPageCount();

								for (let p = 0; p < pageCount; p++) {
									const page = await pdfAnalysis.getPage(p + 1);
									
									const viewport = page.getViewport({scale: 0.5});
									
									// åŠ¨æ€è°ƒæ•´ Canvas å°ºå¯¸ï¼ˆä¼šè‡ªåŠ¨æ¸…ç©ºå†…å®¹ï¼‰
									if (sharedCanvas.width !== viewport.width || sharedCanvas.height !== viewport.height) {
										sharedCanvas.width = viewport.width;
										sharedCanvas.height = viewport.height;
									}

									// æ¸²æŸ“é¡µé¢åˆ° Canvas
									await page.render({
										canvasContext: ctx, 
										viewport: viewport
									}).promise;
									
									// è®¡ç®—åˆ‡åˆ†ç‚¹
									const splitRatio = findSplitRatio(ctx, sharedCanvas.width, sharedCanvas.height, config);
									
									// æ˜¾å¼æ¸…ç†é¡µé¢èµ„æº
									page.cleanup();

									// æ‰§è¡Œåˆ‡åˆ† (pdf-lib)
									const [orig] = await newPdfDoc.copyPages(pdfDoc, [p]);
									const { width, height } = orig.getSize();
									const splitX = width * splitRatio;

									// æ·»åŠ å·¦é¡µ
									const leftP = await newPdfDoc.addPage(orig);
									leftP.setCropBox(0, 0, splitX, height);
									
									// æ·»åŠ å³é¡µ (éœ€é‡æ–°æ‹·è´ä»¥è·å¾—ç‹¬ç«‹å¼•ç”¨)
									const [rightRaw] = await newPdfDoc.copyPages(pdfDoc, [p]);
									const rightP = await newPdfDoc.addPage(rightRaw);
									rightP.setCropBox(splitX, 0, width - splitX, height);
								}
								
								const newBytes = await newPdfDoc.save();
								zip.file(file.name.replace(/\.pdf$/i, '') + '_A4ç‰ˆ.pdf', newBytes);
								successCount++;
								log(`âœ… å®Œæˆ`, 'success');

							} catch (err) {
								log(`âŒ å¤±è´¥: ${err.message}`, 'error');
								console.error(err);
							} finally {
								// å…³é”®ï¼šé”€æ¯ PDF.js ä»»åŠ¡å¯¹è±¡ä»¥é‡Šæ”¾å†…å­˜
								if (loadingTask) {
									await loadingTask.destroy();
								}
							}
						}
						
						// å¤„ç†å®Œæˆåç¼©å° Canvas å ç”¨
						sharedCanvas.width = 1;
						sharedCanvas.height = 1;

						if(successCount > 0) {
							log(`æ­£åœ¨æ‰“åŒ…ä¸‹è½½...`, 'success');
							const content = await zip.generateAsync({type:"blob"});
							const downloadUrl = URL.createObjectURL(content);
							const downloadLink = document.createElement('a');
							downloadLink.href = downloadUrl;
							downloadLink.download = "A3æ™ºèƒ½åˆ‡åˆ†A4ç»“æœ.zip";
							document.body.appendChild(downloadLink);
							downloadLink.click();
							document.body.removeChild(downloadLink);
							// å»¶è¿Ÿé‡Šæ”¾ URL å¯¹è±¡ï¼Œç¡®ä¿ä¸‹è½½è§¦å‘
							setTimeout(() => URL.revokeObjectURL(downloadUrl), 1000);
						}
					} catch (e) { 
						log(`ç³»ç»Ÿä¸¥é‡é”™è¯¯: ${e.message}`, 'error'); 
					} finally {
						log(`å¤„ç†ç»“æŸï¼å…±æˆåŠŸå¤„ç† ${successCount} ä¸ªæ–‡ä»¶`, 'success');
					}
				}
			});
		</script>
		
		<style>
			/* æ»‘å—æ ·å¼ä¼˜åŒ– */
			.slider-thumb::-webkit-slider-thumb {
				appearance: none;
				height: 1.25rem;
				width: 1.25rem;
				border-radius: 50%;
				background: #4f46e5;
				cursor: pointer;
				box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
				transition: all 0.2s ease;
			}
			
			.slider-thumb::-webkit-slider-thumb:hover {
				transform: scale(1.1);
				box-shadow: 0 0 0 6px rgba(79, 70, 229, 0.2);
			}
			
			/* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
			.custom-scrollbar::-webkit-scrollbar {
				width: 4px;
			}
			.custom-scrollbar::-webkit-scrollbar-track {
				background: transparent;
			}
			.custom-scrollbar::-webkit-scrollbar-thumb {
				background-color: rgba(148, 163, 184, 0.3);
				border-radius: 2px;
			}
			.dark .custom-scrollbar::-webkit-scrollbar-thumb {
				background-color: rgba(71, 85, 105, 0.5);
			}
			.custom-scrollbar::-webkit-scrollbar-thumb:hover {
				background-color: rgba(148, 163, 184, 0.5);
			}
			
			/* åŠ¨ç”»å®šä¹‰ */
			@keyframes fadeIn {
				from { opacity: 0; transform: translateY(5px); }
				to { opacity: 1; transform: translateY(0); }
			}
			.animate-fadeIn {
				animation: fadeIn 0.3s ease-out forwards;
			}
		</style>
	</body>
</html>