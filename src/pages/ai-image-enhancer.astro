---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/sections/Footer.astro';
import Header from '../components/sections/Header.astro';
---

<!doctype html>
<html lang="zh-CN" data-theme="dark" class="dark">
	<head>
		<BaseHead title={`Free AI Image Clear & Upscaler`} description="Upscale photos and anime images 4x using Real-ESRGAN. Free and unlimited." />
		<style>
			.spinner {
				border: 4px solid rgba(255, 255, 255, 0.1);
				width: 36px;
				height: 36px;
				border-radius: 50%;
				border-left-color: #ffffff;
				animation: spin 1s ease-in-out infinite;
			}
			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}
            .hidden { display: none !important; }
		</style>
	</head>
	<body>
		<svg style="display: none;" aria-hidden="true">
			<symbol id="icon-upload" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
			</symbol>
            <symbol id="icon-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M12 12.75l-4.5-4.5M12 12.75l4.5-4.5M12 12.75V3" />
            </symbol>
		</svg>

		<Header />
		<main>
			<section class="py-1 px-4">
				<div class="max-w-6xl mx-auto">
					<h1 class="text-3xl md:text-4xl font-bold text-center mb-8">AI Image Clear & Upscaler </h1>
					
					<div class="card-surface p-8">
						<div class="w-full transition-all duration-300 mb-6 text-center">
							<div class="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-10 bg-gray-50 dark:bg-gray-800/50 relative">
								
                                <!-- 上传区域 -->
                                <div id="upload-container">
                                    <div class="w-20 h-20 bg-primary/10 text-primary rounded-full flex items-center justify-center mb-6 mx-auto">
                                        <svg class="w-10 h-10"><use href="#icon-upload"></use></svg>
                                    </div>
                                    <h3 class="font-semibold text-xl mb-3">Upload Image to Upscale</h3>
                                    
                                    <!-- 限制提示信息 -->
                                    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 rounded-lg p-3 max-w-sm mx-auto mb-6">
                                        <p class="text-sm text-yellow-700 dark:text-yellow-500 font-bold">
                                            ⚠️ Limits for Fast Speed:
                                        </p>
                                        <ul class="text-xs text-yellow-600 dark:text-yellow-400 mt-1 space-y-1">
                                            <li>• Max Size: <strong>1 MB</strong></li>
                                            <li>• Max Dimension: <strong>500 px</strong></li>
                                        </ul>
                                    </div>
                                    
                                    <label for="file-upload" class="cursor-pointer inline-flex items-center justify-center gap-2 px-10 py-3 bg-primary text-white rounded-lg text-sm font-bold hover:bg-primary/90 transition-colors shadow-lg shadow-primary/20">
                                        <span>Choose File</span>
                                        <input id="file-upload" type="file" accept="image/*" class="hidden" />
                                    </label>
                                </div>

                                <!-- 处理与结果区域 -->
                                <div id="process-container" class="hidden flex flex-col items-center w-full">
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full mb-8 items-start">
                                        <!-- 原图 -->
                                        <div class="flex flex-col items-center md:col-span-1">
                                            <span class="text-sm font-bold text-gray-500 mb-2 uppercase tracking-wide">Original</span>
                                            <div class="relative group w-full bg-black/5 dark:bg-white/5 rounded-lg overflow-hidden flex justify-center">
                                                <img id="preview-image" class="h-auto max-h-[400px] object-contain" />
                                            </div>
                                            <div id="preview-info" class="mt-2 text-xs text-gray-500 font-mono bg-gray-200 dark:bg-gray-800 px-2 py-1 rounded">
                                                - x - px
                                            </div>
                                        </div>
                                        
                                        <!-- 结果图 -->
                                        <div class="flex flex-col items-center md:col-span-2 relative min-h-[300px] bg-black/5 dark:bg-white/5 rounded-xl border border-gray-200 dark:border-gray-700 p-2">
                                            <span class="text-sm font-bold text-primary mb-2 uppercase tracking-wide">Upscaled Result (4x)</span>
                                            
                                            <!-- 结果图 -->
                                            <img id="result-image" crossorigin="anonymous" class="hidden w-full h-auto max-h-[500px] object-contain z-10" />
                                            
                                            <!-- 结果信息 -->
                                            <div id="result-info" class="hidden mt-3 text-sm text-primary font-mono bg-primary/10 px-3 py-1.5 rounded border border-primary/20">
                                                Calculating size...
                                            </div>
                                            
                                            <!-- 加载动画 -->
                                            <div id="loading-spinner" class="hidden flex flex-col items-center justify-center absolute inset-0 z-0">
                                                <div class="spinner border-primary mb-3"></div>
                                                <p class="text-sm text-gray-500 animate-pulse font-medium" id="status-text">Ready</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 模型选择 -->
                                    <div class="flex justify-center items-center gap-6 mb-6 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                                        <span class="font-bold text-sm mr-2">Mode:</span>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="model_type" value="base" checked class="w-4 h-4 text-primary accent-primary">
                                            <span class="text-sm">Photo (Base)</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="model_type" value="anime" class="w-4 h-4 text-primary accent-primary">
                                            <span class="text-sm">Anime / Cartoon</span>
                                        </label>
                                    </div>

                                    <!-- 按钮栏 -->
                                    <div class="flex flex-wrap justify-center gap-4 w-full border-t border-gray-200 dark:border-gray-700 pt-6">
                                        <button id="enhance-btn" class="inline-flex items-center justify-center gap-2 px-8 py-3 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700 transition-colors shadow-lg shadow-green-600/20 disabled:opacity-50 disabled:cursor-not-allowed">
                                            Start Upscaling
                                        </button>

                                        <div id="download-group" class="hidden flex gap-2">
                                            <button id="download-jpg-btn" class="inline-flex items-center justify-center gap-2 px-5 py-3 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 transition-colors shadow-lg">
                                                <svg class="w-4 h-4"><use href="#icon-download"></use></svg> JPG
                                            </button>
                                            <button id="download-png-btn" class="inline-flex items-center justify-center gap-2 px-5 py-3 bg-purple-600 text-white rounded-lg text-sm font-bold hover:bg-purple-700 transition-colors shadow-lg">
                                                <svg class="w-4 h-4"><use href="#icon-download"></use></svg> PNG
                                            </button>
                                        </div>

                                        <button id="reset-btn" class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-white rounded-lg text-sm font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                            Reset
                                        </button>
                                    </div>
                                    
                                    <p id="error-msg" class="text-red-500 text-sm mt-4 hidden font-medium text-center bg-red-50 dark:bg-red-900/20 p-2 rounded"></p>
                                </div>

								<p class="text-center text-gray-500 text-sm mt-6">Powered by Real-ESRGAN</p>
							</div>
						</div>
					</div>
				</div>
			</section>
		</main>
		<!-- Additional Information Section -->
		<section class="py-16 px-4 bg-slate-50 dark:bg-slate-900/30">
			<div class="max-w-4xl mx-auto">
				<!-- Features Section -->
				<div class="mb-12">
					<h2 class="text-2xl font-bold text-center mb-8 text-slate-800 dark:text-slate-100 flex items-center justify-center gap-3">
					✅Features
					</h2>
					<div class="grid md:grid-cols-2 gap-6">
						<div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
							<ul class="space-y-3 text-slate-600 dark:text-slate-300">
								<li class="flex items-start gap-3">
									<span class="text-green-500 mt-1">✓</span>
									<span>AI-powered image enhancement</span>
								</li>
								<li class="flex items-start gap-3">
									<span class="text-green-500 mt-1">✓</span>
									<span>High-quality image upscaling</span>
								</li>
								<li class="flex items-start gap-3">
									<span class="text-green-500 mt-1">✓</span>
									<span>No signup, no watermark</span>
								</li>
							</ul>
						</div>
						<div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
							<ul class="space-y-3 text-slate-600 dark:text-slate-300">
								<li class="flex items-start gap-3">
									<span class="text-green-500 mt-1">✓</span>
									<span>Works on Windows, macOS, and mobile</span>
								</li>
								<li class="flex items-start gap-3">
									<span class="text-green-500 mt-1">✓</span>
									<span>Free to use online</span>
								</li>
							</ul>
						</div>
					</div>
				</div>
				
				<hr class="my-12 border-slate-200 dark:border-slate-700">
				
				<!-- Use Cases Section -->
				<div class="mb-12">
					<h2 class="text-2xl font-bold text-center mb-8 text-slate-800 dark:text-slate-100">✅ Use Cases</h2>
					<div class="text-center mb-6">
						<p class="text-lg text-slate-600 dark:text-slate-300 font-medium">Perfect for:</p>
					</div>
					<div class="grid md:grid-cols-2 gap-6">
						<div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
							<ul class="space-y-3 text-slate-600 dark:text-slate-300">
								<li class="flex items-start gap-3">
									<span class="text-blue-500 mt-1">•</span>
									<span>Enhancing old or blurry photos</span>
								</li>
								<li class="flex items-start gap-3">
									<span class="text-blue-500 mt-1">•</span>
									<span>Upscaling low-resolution images</span>
								</li>
								<li class="flex items-start gap-3">
									<span class="text-blue-500 mt-1">•</span>
									<span>Improving product photos</span>
								</li>
							</ul>
						</div>
						<div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
							<ul class="space-y-3 text-slate-600 dark:text-slate-300">
								<li class="flex items-start gap-3">
									<span class="text-blue-500 mt-1">•</span>
									<span>Enhancing digital art and illustrations</span>
								</li>
								<li class="flex items-start gap-3">
									<span class="text-blue-500 mt-1">•</span>
									<span>Preparing images for printing</span>
								</li>
							</ul>
						</div>
					</div>
				</div>
				
				<hr class="my-12 border-slate-200 dark:border-slate-700">
				
				<!-- CTA Section -->
				<div class="text-center mb-12">
					<h2 class="text-2xl font-bold mb-4 text-slate-800 dark:text-slate-100">✅ CTA</h2>
					<div class="bg-gradient-to-r from-primary to-blue-600 rounded-2xl p-8 shadow-lg">
						<h3 class="text-3xl font-bold text-white mb-4">Enhance Your Images Now — Free</h3>
						<p class="text-blue-100 text-lg mb-6">Start enhancing and upscaling your images with advanced AI technology instantly</p>
						<button onclick="window.location.href = '#';" class="bg-white text-primary font-bold px-8 py-3 rounded-lg hover:bg-slate-100 transition-colors shadow-lg">
							Start Enhancing
						</button>
					</div>
				</div>
				
				<hr class="my-12 border-slate-200 dark:border-slate-700">
				
				<!-- FAQ Section -->
				<div>
					<h2 class="text-2xl font-bold text-center mb-8 text-slate-800 dark:text-slate-100">✅ FAQ</h2>
					<div class="space-y-6">
						<div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
							<h3 class="font-semibold text-slate-800 dark:text-slate-100 mb-2">How does AI image enhancement work?</h3>
							<p class="text-slate-600 dark:text-slate-300">Our tool uses advanced AI algorithms to analyze and improve images, enhancing details, colors, and overall quality.</p>
						</div>
						<div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
							<h3 class="font-semibold text-slate-800 dark:text-slate-100 mb-2">Is this image enhancer free?</h3>
							<p class="text-slate-600 dark:text-slate-300">Yes. Our AI image enhancer is completely free to use with no registration required.</p>
						</div>
						<div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
							<h3 class="font-semibold text-slate-800 dark:text-slate-100 mb-2">What image formats are supported?</h3>
							<p class="text-slate-600 dark:text-slate-300">The tool supports common image formats such as JPG, PNG, and WebP.</p>
						</div>
						<div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
							<h3 class="font-semibold text-slate-800 dark:text-slate-100 mb-2">Can I upscale images without losing quality?</h3>
							<p class="text-slate-600 dark:text-slate-300">Yes. Our AI upscaling technology preserves details and enhances quality while increasing resolution.</p>
						</div>
					</div>
				</div>
			</div>
		</section>
		<Footer />

        <script>
            // Space URL
            const SPACE_URL = "https://eternalpal-real-esrgan-image.hf.space"; 
            
            // ★★★ 限制配置 (Limits) ★★★
            const MAX_FILE_SIZE_MB = 1;  // 限制 1MB
            const MAX_DIMENSION = 500;   // 限制 500px

            // DOM 引用
            const fileInput = document.getElementById('file-upload');
            const uploadContainer = document.getElementById('upload-container');
            const processContainer = document.getElementById('process-container');
            const previewImage = document.getElementById('preview-image');
            const previewInfo = document.getElementById('preview-info');
            const resultImage = document.getElementById('result-image');
            const resultInfo = document.getElementById('result-info');
            const loadingSpinner = document.getElementById('loading-spinner');
            const statusText = document.getElementById('status-text');
            const enhanceBtn = document.getElementById('enhance-btn');
            const resetBtn = document.getElementById('reset-btn');
            const errorMsg = document.getElementById('error-msg');
            const downloadGroup = document.getElementById('download-group');
            const btnJpg = document.getElementById('download-jpg-btn');
            const btnPng = document.getElementById('download-png-btn');

            let currentFile = null;

            // 辅助函数：格式化大小
            function formatBytes(bytes, decimals = 1) {
                if (!+bytes) return '0 Bytes';
                const k = 1024;
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(decimals))} ${['Bytes', 'KB', 'MB', 'GB'][i]}`;
            }

            // 辅助函数：更新尺寸
            function updateImageDimensions(imgElement, infoElement, fileSize = null) {
                const width = imgElement.naturalWidth;
                const height = imgElement.naturalHeight;
                let text = `${width} x ${height} px`;
                if (fileSize) text += ` • ${formatBytes(fileSize)}`;
                infoElement.innerText = text;
                infoElement.classList.remove('hidden');
            }

            // 辅助函数：下载
            function downloadImage(format) {
                if (!resultImage.src) return;
                const canvas = document.createElement('canvas');
                canvas.width = resultImage.naturalWidth;
                canvas.height = resultImage.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(resultImage, 0, 0);
                const dataUrl = canvas.toDataURL(format === 'jpg' ? 'image/jpeg' : 'image/png', 0.95);
                const link = document.createElement('a');
                link.download = `upscaled_${Date.now()}.${format}`;
                link.href = dataUrl;
                link.click();
            }

            // 辅助函数：将 File 转为 Base64
            function convertFileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            // 1. 原图加载 (带严格限制)
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // 体积校验 (FileSize Check)
                if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                    alert(`File too large!\n\nCurrent: ${(file.size / 1024 / 1024).toFixed(2)} MB\nLimit: ${MAX_FILE_SIZE_MB} MB\n\nPlease use a smaller image for fast processing.`);
                    fileInput.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    // 创建图片对象检查尺寸
                    const img = new Image();
                    img.onload = () => {
                        // 尺寸校验 (Dimensions Check)
                        if (img.width > MAX_DIMENSION || img.height > MAX_DIMENSION) {
                            alert(`Dimensions too large!\n\nCurrent: ${img.width} x ${img.height} px\nLimit: ${MAX_DIMENSION} x ${MAX_DIMENSION} px\n\nSince this is a 4x upscaler, input must be small to prevent server crash.`);
                            fileInput.value = '';
                            currentFile = null;
                            return;
                        }

                        // 校验通过，加载预览
                        currentFile = file;
                        previewImage.src = img.src;
                        uploadContainer.classList.add('hidden');
                        processContainer.classList.remove('hidden');
                        errorMsg.classList.add('hidden');
                        updateImageDimensions(previewImage, previewInfo, file.size);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });

            // 2. 重置
            resetBtn.addEventListener('click', () => {
                currentFile = null;
                fileInput.value = '';
                resultImage.classList.add('hidden');
                resultImage.src = '';
                resultInfo.classList.add('hidden');
                processContainer.classList.add('hidden');
                uploadContainer.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                downloadGroup.classList.add('hidden');
                enhanceBtn.disabled = false;
                enhanceBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                enhanceBtn.classList.remove('hidden');
                errorMsg.classList.add('hidden');
            });

            // 3. 执行放大 (使用原生 fetch)
            enhanceBtn.addEventListener('click', async () => {
                if (!currentFile) return;

                const modelType = document.querySelector('input[name="model_type"]:checked').value;

                // UI 更新
                loadingSpinner.classList.remove('hidden');
                resultImage.classList.add('hidden');
                resultInfo.classList.add('hidden');
                downloadGroup.classList.add('hidden');
                enhanceBtn.disabled = true;
                enhanceBtn.classList.add('opacity-50', 'cursor-not-allowed');
                statusText.innerText = "Encoding image...";
                errorMsg.classList.add('hidden');

                try {
                    // 1. 转 Base64
                    const base64Image = await convertFileToBase64(currentFile);
                    
                    statusText.innerText = "Processing (Wait ~10-20s)...";

                    // 2. 构造请求 Payload
                    // 对应后端 inputs: [Image(type="pil"), Radio]
                    const payload = {
                        "data": [
                            base64Image, // 图片数据
                            modelType    // 模式字符串
                        ]
                    };

                    // 3. 发送 POST 请求到 /run/predict
                    // (Gradio 3.x 使用 /run/predict 作为标准无状态接口)
                    const response = await fetch(`${SPACE_URL}/run/predict`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Server Error: ${response.status}`);
                    }

                    const json = await response.json();
                    
                    // 4. 处理结果
                    // Gradio 3.x 返回格式通常是 { "data": ["路径"] }
                    if (json.data && json.data.length > 0) {
                        let outputData = json.data[0];
                        
                        // 如果返回的是相对路径 (例如 "/tmp/..."), 需要拼接 Space URL
                        // 如果返回的是 data:image/base64，则直接用
                        let finalUrl = outputData;
                        
                        // 检查是否是文件路径 (通常以 /tmp 开头或不含 http)
                        if (typeof outputData === 'string' && !outputData.startsWith('data:') && !outputData.startsWith('http')) {
                            // Gradio 3.x 的文件访问端点通常是 /file=
                            finalUrl = `${SPACE_URL}/file=${outputData}`;
                        }

                        console.log("Output URL:", finalUrl);

                        resultImage.src = finalUrl;
                        resultImage.onload = () => {
                            resultImage.classList.remove('hidden');
                            loadingSpinner.classList.add('hidden');
                            statusText.innerText = "Done!";
                            downloadGroup.classList.remove('hidden');
                            enhanceBtn.classList.add('hidden');
                            updateImageDimensions(resultImage, resultInfo);
                        };
                        resultImage.onerror = () => {
                            throw new Error("Failed to load result image");
                        };
                    } else {
                        throw new Error("Empty response from server");
                    }

                } catch (error) {
                    console.error(error);
                    statusText.innerText = "Error";
                    errorMsg.innerText = "Failed: " + error.message;
                    errorMsg.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    enhanceBtn.disabled = false;
                    enhanceBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });

            btnJpg.addEventListener('click', () => downloadImage('jpg'));
            btnPng.addEventListener('click', () => downloadImage('png'));
        </script>
	</body>
</html>
