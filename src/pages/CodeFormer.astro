---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/sections/Footer.astro';
import Header from '../components/sections/Header.astro';
---

<!doctype html>
<html lang="zh-CN" data-theme="dark" class="dark">
	<head>
		<BaseHead title={`Free AI Face Restorer (CodeFormer)`} description="Restore old photos and fix faces with CodeFormer. Free and unlimited on CPU." />
		<style>
			.spinner {
				border: 4px solid rgba(255, 255, 255, 0.1);
				width: 36px;
				height: 36px;
				border-radius: 50%;
				border-left-color: #8b5cf6; /* Purple */
				animation: spin 1s ease-in-out infinite;
			}
			@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .hidden { display: none !important; }
		</style>
	</head>
	<body>
        <!-- 图标省略，使用之前的即可 -->
		<Header />
		<main>
			<section class="py-1 px-4">
				<div class="max-w-6xl mx-auto">
					<h1 class="text-3xl md:text-4xl font-bold text-center mb-8">AI Face Restoration (CodeFormer)</h1>
					
					<div class="card-surface p-8">
						<div class="w-full transition-all duration-300 mb-6 text-center">
							<div class="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-8 bg-gray-50 dark:bg-gray-800/50 relative">
								
                                <!-- Upload -->
                                <div id="upload-container">
                                    <div class="w-20 h-20 bg-purple-500/10 text-purple-500 rounded-full flex items-center justify-center mb-6 mx-auto">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 0 1-6.364 0M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0ZM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Z" />
                                        </svg>
                                    </div>
                                    <h3 class="font-semibold text-xl mb-3">Restore Old Photos & Faces</h3>
                                    <p class="text-gray-500 text-base max-w-sm text-center leading-relaxed mx-auto mb-6">
                                        Best for portraits and old photos. <br>
                                        <span class="text-xs text-green-600">Free & Unlimited (CPU Mode)</span>
                                    </p>
                                    <label for="file-upload" class="cursor-pointer inline-flex items-center justify-center gap-2 px-10 py-3 bg-purple-600 text-white rounded-lg text-sm font-bold hover:bg-purple-700 transition-colors shadow-lg">
                                        <span>Choose File</span>
                                        <input id="file-upload" type="file" accept="image/*" class="hidden" />
                                    </label>
                                </div>

                                <!-- Process -->
                                <div id="process-container" class="hidden flex flex-col items-center w-full">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full mb-8 items-start">
                                        <div class="flex flex-col items-center">
                                            <span class="text-sm font-bold text-gray-500 mb-2">Original</span>
                                            <img id="preview-image" class="w-full h-auto max-h-[500px] object-contain rounded-lg shadow-sm" />
                                        </div>
                                        <div class="flex flex-col items-center relative min-h-[300px]">
                                            <span class="text-sm font-bold text-purple-500 mb-2">Restored Result</span>
                                            <div class="relative w-full bg-black/5 dark:bg-white/5 rounded-lg overflow-hidden min-h-[300px] flex items-center justify-center">
                                                <img id="result-image" crossorigin="anonymous" class="hidden w-full h-auto max-h-[500px] object-contain z-10 rounded-lg" />
                                                <div id="loading-spinner" class="hidden flex flex-col items-center justify-center absolute inset-0 z-0">
                                                    <div class="spinner border-purple-500 mb-4"></div>
                                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-300 animate-pulse" id="status-text">Ready</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Controls -->
                                    <div class="flex flex-wrap justify-center gap-6 mb-6 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                                        <label class="flex items-center gap-2 cursor-pointer" title="Enhance the background, not just faces">
                                            <input type="checkbox" id="bg-enhance" checked class="w-4 h-4 text-purple-600 rounded">
                                            <span class="text-sm font-medium">Background Enhance</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer" title="Upscale the image by 2x">
                                            <input type="checkbox" id="upscale-check" checked class="w-4 h-4 text-purple-600 rounded">
                                            <span class="text-sm font-medium">Upscale 2x</span>
                                        </label>
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-medium">Fidelity:</span>
                                            <input type="range" id="fidelity-slider" min="0" max="1" step="0.1" value="0.7" class="w-24 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-purple-600">
                                            <span class="text-xs text-gray-500" id="fidelity-val">0.7</span>
                                        </div>
                                    </div>

                                    <div class="flex flex-wrap justify-center gap-4 w-full">
                                        <button id="enhance-btn" class="inline-flex items-center justify-center gap-2 px-8 py-3 bg-purple-600 text-white rounded-lg text-sm font-bold hover:bg-purple-700 transition-colors shadow-lg">Start Restoring</button>
                                        <button id="download-btn" class="hidden inline-flex items-center justify-center gap-2 px-8 py-3 bg-gray-700 text-white rounded-lg text-sm font-bold hover:bg-gray-600 transition-colors">Download</button>
                                        <button id="reset-btn" class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-white rounded-lg text-sm font-bold hover:bg-gray-300 transition-colors">Reset</button>
                                    </div>
                                    <p id="error-msg" class="text-red-500 text-sm mt-4 hidden"></p>
                                </div>
                                
                                <p class="text-center text-gray-500 text-xs mt-8">Powered by <a href="#" target="_blank" class="text-purple-500 hover:underline">CodeFormer</a> on Free CPU.</p>
							</div>
						</div>
					</div>
				</div>
			</section>
		</main>
		<Footer />

        <!-- 引入最新的 Client -->
        <script type="module">
            import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client@latest/+esm";

            // ★★★ 这里填你复制出来的 Space ID (例如 user/CodeFormer) ★★★
            // sczhou/CodeFormer 是官方的，人多可能会排队，强烈建议用你自己的副本
            const SPACE_ID = "sczhou/CodeFormer"; 

            const fileInput = document.getElementById('file-upload');
            const uploadContainer = document.getElementById('upload-container');
            const processContainer = document.getElementById('process-container');
            const previewImage = document.getElementById('preview-image');
            const resultImage = document.getElementById('result-image');
            const loadingSpinner = document.getElementById('loading-spinner');
            const statusText = document.getElementById('status-text');
            const enhanceBtn = document.getElementById('enhance-btn');
            const resetBtn = document.getElementById('reset-btn');
            const downloadBtn = document.getElementById('download-btn');
            const errorMsg = document.getElementById('error-msg');
            
            const bgEnhanceCheck = document.getElementById('bg-enhance');
            const upscaleCheck = document.getElementById('upscale-check');
            const fidelitySlider = document.getElementById('fidelity-slider');
            const fidelityVal = document.getElementById('fidelity-val');

            let currentFile = null;
            let appClient = null;

            fidelitySlider.addEventListener('input', (e) => fidelityVal.innerText = e.target.value);

            // 连接 API
            (async () => {
                try {
                    console.log("Connecting...");
                    appClient = await Client.connect(SPACE_ID);
                    console.log("✅ Connected");
                } catch (e) {
                    console.error("Connection failed", e);
                }
            })();

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                currentFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    uploadContainer.classList.add('hidden');
                    processContainer.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            });

            resetBtn.addEventListener('click', () => {
                currentFile = null;
                fileInput.value = '';
                resultImage.classList.add('hidden');
                resultImage.src = '';
                processContainer.classList.add('hidden');
                uploadContainer.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                downloadBtn.classList.add('hidden');
                enhanceBtn.disabled = false;
                enhanceBtn.classList.remove('opacity-50');
            });

            enhanceBtn.addEventListener('click', async () => {
                if(!currentFile) return;
                if(!appClient) {
                    try {
                        statusText.innerText = "Connecting...";
                        appClient = await Client.connect(SPACE_ID);
                    } catch(e) { alert("Connect failed. Check VPN."); return; }
                }

                loadingSpinner.classList.remove('hidden');
                resultImage.classList.add('hidden');
                downloadBtn.classList.add('hidden');
                enhanceBtn.disabled = true;
                enhanceBtn.classList.add('opacity-50');
                statusText.innerText = "Processing (CPU mode ~40s)...";
                errorMsg.classList.add('hidden');

                try {
                    // CodeFormer API 参数结构 (基于官方 Space)
                    // predict(image, background_enhance, face_upsample, upscale_factor, codeformer_fidelity)
                    const result = await appClient.predict("/predict", [
                        currentFile,                // 0: Image
                        bgEnhanceCheck.checked,     // 1: Background Enhance (Bool)
                        true,                       // 2: Face Upsample (Bool) - 强制开启人脸修复
                        upscaleCheck.checked ? 2 : 1, // 3: Upscale (1 or 2)
                        parseFloat(fidelitySlider.value) // 4: Fidelity (0.0 - 1.0)
                    ]);

                    if (result && result.data) {
                        const output = result.data[0]; // CodeFormer return path string usually
                        const url = output.url || output;
                        
                        resultImage.src = url;
                        resultImage.onload = () => {
                            resultImage.classList.remove('hidden');
                            loadingSpinner.classList.add('hidden');
                            downloadBtn.classList.remove('hidden');
                            statusText.innerText = "Done!";
                        };
                    }
                } catch (error) {
                    console.error(error);
                    statusText.innerText = "Error";
                    errorMsg.innerText = "Failed: " + error.message;
                    errorMsg.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    enhanceBtn.disabled = false;
                    enhanceBtn.classList.remove('opacity-50');
                }
            });

            downloadBtn.addEventListener('click', () => {
                if(!resultImage.src) return;
                const link = document.createElement('a');
                link.href = resultImage.src;
                link.download = `restored_${Date.now()}.png`;
                link.click();
            });
        </script>
	</body>
</html>