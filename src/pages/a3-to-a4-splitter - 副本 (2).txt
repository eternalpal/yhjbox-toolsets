---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/sections/Footer.astro';
import Header from '../components/sections/Header.astro';
import { SITE_TITLE } from '../consts';
---

<!doctype html>
<html lang="zh-CN" data-theme="dark" class="dark">
	<head>
		<BaseHead title={`A3 to A4 Splitter - ${SITE_TITLE}`} description="æ™ºèƒ½åˆ‡åˆ†å·¥å…·ï¼Œå°†A3è¯•å·PDFè½¬æ¢ä¸ºA4æ ¼å¼ï¼Œæ”¯æŒæ‰¹é‡å¤„ç†å’Œå‚æ•°è°ƒæ•´" />
	</head>
	<body>
		<Header />
		<main>
			<section class="py-1 px-4">
				<div class="max-w-4xl mx-auto">
					<h1 class="text-3xl md:text-4xl font-bold text-center mb-8">A3 Splitter Pro</h1>
					<div class="card-surface p-8">
				
				<!-- ä¸Šä¼ åŒºåŸŸ -->
				<div id="uploadSection" class="w-full transition-all duration-300 mb-6">
					<div id="dropZone" class="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-10 cursor-pointer hover:border-primary dark:hover:border-primary hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all duration-200 group flex flex-col items-center justify-center min-h-[280px]">
						<div class="w-20 h-20 bg-primary/10 text-primary rounded-full flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-200">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
								<path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
							</svg>
						</div>
						<h3 class="font-semibold text-xl mb-3">ç‚¹å‡»æˆ–æ‹–æ”¾ä¸Šä¼  PDF</h3>
						<p class="text-gray-500 text-base max-w-sm text-center leading-relaxed">
							æ”¯æŒæ‰¹é‡é€‰æ‹©æ–‡ä»¶ï¼Œè‡ªåŠ¨è¯†åˆ« A3 è¯•å·ç»“æ„
						</p>
						<input type="file" id="fileInput" multiple accept=".pdf" class="hidden">
					</div>
				</div>
				
				<!-- æ–‡ä»¶åˆ—è¡¨åŒºåŸŸ -->
				<div id="filesSection" class="w-full hidden">
					<div class="flex flex-col border border-gray-300 dark:border-gray-700 rounded-lg">
						<!-- åˆ—è¡¨å¤´éƒ¨ -->
						<div class="flex justify-between items-center px-5 py-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 rounded-t-lg">
							<div class="flex items-center gap-2">
								<span class="flex h-2 w-2 rounded-full bg-green-500"></span>
								<h5 class="font-medium text-sm">å¾…å¤„ç†æ–‡ä»¶</h5>
							</div>
							<div class="flex items-center gap-3">
								<span id="fileCount" class="text-gray-500 text-xs font-mono bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded">0</span>
								<button id="clearBtn" class="text-xs text-red-500 hover:text-red-600 transition-colors flex items-center gap-1 cursor-pointer">
									æ¸…ç©º
								</button>
							</div>
						</div>
						
						<!-- æ–‡ä»¶åˆ—è¡¨å®¹å™¨ -->
						<div id="fileListContainer" class="max-h-[180px] overflow-y-auto custom-scrollbar p-3 space-y-2 bg-white dark:bg-gray-800/30">
							<ul id="fileList" class="space-y-2"></ul>
						</div>
						
						<!-- åº•éƒ¨æ“ä½œæ  -->
						<div id="addMore" class="p-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/30 rounded-b-lg flex justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
							<span class="text-primary text-sm font-medium flex items-center gap-2">
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
									<path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
								</svg>
								ç»§ç»­æ·»åŠ æ–‡ä»¶
							</span>
						</div>
					</div>
				</div>
			</div>
			
			<!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
			<div class="w-full max-w-4xl mt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
				<div class="flex gap-6 w-full sm:w-auto">
					<button id="helpBtn" class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-6 py-3 bg-gray-100 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-700 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white transition-colors">
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
							<path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18-3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
						</svg>
						æ•™ç¨‹
					</button>
					<button id="settingsBtn" class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-6 py-3 bg-gray-100 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-700 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white transition-colors">
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
							<path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
						</svg>
						è®¾ç½®
					</button>
					<button id="logsBtn" class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-6 py-3 bg-gray-100 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-700 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white transition-colors">
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
							<path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z" />
						</svg>
						æ—¥å¿—
					</button>
				</div>
				
				<button id="startBtn" class="w-full sm:w-auto flex-1 flex items-center justify-center gap-2 px-10 py-3 bg-primary text-white rounded-lg text-sm font-bold hover:bg-primary/90 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
						<path d="M10 2a.75.75 0 0 1 .75.75v12.59l1.95-2.1a.75.75 0 1 1 1.1 1.02l-3.25 3.5a.75.75 0 0 0-1.1 0l-3.25-3.5a.75.75 0 1 1 1.1-1.02l1.95 2.1V2.75A.75.75 0 0 1 10 2Z" />
					</svg>
					å¼€å§‹å¤„ç†
				</button>
			</div>
		</main>
		
		<!-- æ¨¡æ€æ¡†èƒŒæ™¯ -->
		<div id="modalOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden items-center justify-center transition-opacity duration-300 opacity-0">
			<!-- è®¾ç½®æ¨¡æ€æ¡† -->
			<div id="settingsModal" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 hidden transform transition-all duration-300 scale-95 border border-slate-200 dark:border-slate-700">
				<div class="flex justify-between items-center mb-6">
					<h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
						<span class="text-indigo-500">âš™ï¸</span> å¤„ç†å‚æ•°
					</h2>
					<button data-close="settingsModal" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
							<path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
						</svg>
					</button>
				</div>
				<div class="space-y-6">
					<!-- æ°´å°é˜ˆå€¼ -->
					<div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl">
						<div class="flex justify-between items-center mb-3">
							<label class="font-medium text-slate-700 dark:text-slate-300 text-sm">æ°´å°è¿‡æ»¤é˜ˆå€¼</label>
							<input type="number" id="thresholdNum" value="220" min="150" max="250" class="w-16 p-1 px-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-center text-sm font-mono focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none">
						</div>
						<input type="range" id="thresholdRange" min="150" max="250" value="220" class="w-full h-1.5 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer slider-thumb">
						<p class="text-slate-400 text-xs mt-2">æ•°å€¼è¶Šä½è¿‡æ»¤è¶Šå¼ºï¼Œä½†å¯èƒ½è¯¯ä¼¤æ–‡å­—</p>
					</div>
					
					<!-- åˆ†å‰²èŒƒå›´ -->
					<div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl">
						<label class="font-medium text-slate-700 dark:text-slate-300 block mb-3 text-sm">ä¸­ç¼æœç´¢èŒƒå›´ (%)</label>
						<div class="flex items-center gap-3">
							<input type="number" id="scanMin" value="30" min="0" max="100" class="flex-1 p-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-center text-sm font-mono focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none">
							<span class="text-slate-400 text-xs">è‡³</span>
							<input type="number" id="scanMax" value="70" min="0" max="100" class="flex-1 p-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-center text-sm font-mono focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none">
						</div>
					</div>
					
					<!-- å¿½ç•¥èŒƒå›´ -->
					<div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl">
						<label class="font-medium text-slate-700 dark:text-slate-300 block mb-3 text-sm">ä¸Šä¸‹å¿½ç•¥é«˜åº¦ (%)</label>
						<div class="grid grid-cols-2 gap-3">
							<div>
								<label class="text-slate-400 text-xs block mb-1">é¡¶éƒ¨å¿½ç•¥</label>
								<input type="number" id="ignoreTop" value="15" min="0" max="100" class="w-full p-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-center text-sm font-mono focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none">
							</div>
							<div>
								<label class="text-slate-400 text-xs block mb-1">åº•éƒ¨å¿½ç•¥</label>
								<input type="number" id="ignoreBottom" value="15" min="0" max="100" class="w-full p-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-center text-sm font-mono focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none">
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<!-- ä½¿ç”¨è¯´æ˜æ¨¡æ€æ¡† -->
			<div id="helpModal" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 hidden transform transition-all duration-300 scale-95 border border-slate-200 dark:border-slate-700">
				<div class="flex justify-between items-center mb-6">
					<h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
						<span class="text-indigo-500">ğŸ“–</span> ä½¿ç”¨æ•™ç¨‹
					</h2>
					<button data-close="helpModal" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
							<path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
						</svg>
					</button>
				</div>
				<div class="space-y-4">
					<div class="flex gap-4 items-start p-3 rounded-lg bg-slate-50 dark:bg-slate-900/50">
						<span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-400 font-bold text-sm flex items-center justify-center mt-0.5">1</span>
						<p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">ç‚¹å‡»ä¸Šä¼ åŒºåŸŸæˆ–ç›´æ¥å°† PDF æ–‡ä»¶æ‹–å…¥æ¡†å†…ï¼ˆæ”¯æŒå¤šé€‰ï¼‰ã€‚</p>
					</div>
					<div class="flex gap-4 items-start p-3 rounded-lg bg-slate-50 dark:bg-slate-900/50">
						<span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-400 font-bold text-sm flex items-center justify-center mt-0.5">2</span>
						<p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">åœ¨æ–‡ä»¶åˆ—è¡¨ä¸­ç¡®è®¤æ–‡ä»¶ï¼Œå¦‚æœ‰éœ€è¦å¯åœ¨"è®¾ç½®"ä¸­è°ƒæ•´åˆ‡åˆ†å‚æ•°ã€‚</p>
					</div>
					<div class="flex gap-4 items-start p-3 rounded-lg bg-slate-50 dark:bg-slate-900/50">
						<span class="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-400 font-bold text-sm flex items-center justify-center mt-0.5">3</span>
						<p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed">ç‚¹å‡»"å¼€å§‹å¤„ç†"ï¼Œå®Œæˆåä¼šè‡ªåŠ¨ä¸‹è½½å¤„ç†å¥½çš„ ZIP å‹ç¼©åŒ…ã€‚</p>
					</div>
				</div>
			</div>
			
			<!-- å¤„ç†æ—¥å¿—æ¨¡æ€æ¡† -->
			<div id="logsModal" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 hidden transform transition-all duration-300 scale-95 border border-slate-200 dark:border-slate-700">
				<div class="flex justify-between items-center mb-4">
					<h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
						<span class="text-indigo-500">ğŸ“‹</span> å¤„ç†æ—¥å¿—
					</h2>
					<button data-close="logsModal" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
							<path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
						</svg>
					</button>
				</div>
				<div class="bg-slate-950 text-slate-200 rounded-xl p-4 h-[300px] overflow-y-auto font-mono text-xs leading-relaxed border border-slate-800 shadow-inner" id="logArea">
					<div class="text-slate-500 italic mb-2"># ç³»ç»Ÿå‡†å¤‡å°±ç»ª...</div>
				</div>
			</div>
		</div>
		
		<Footer />
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
		<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
		
		<script>
			window.addEventListener('DOMContentLoaded', () => {
				// PDFJS é…ç½®
				if (typeof pdfjsLib !== 'undefined') {
					pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
				} else {
					console.error('PDF.js åº“æœªåŠ è½½ï¼Œæ ¸å¿ƒåŠŸèƒ½å°†æ— æ³•ä½¿ç”¨ã€‚');
					return;
				}

				// DOM å…ƒç´ å¼•ç”¨
				const dom = {
					fileInput: document.getElementById('fileInput'),
					fileListEl: document.getElementById('fileList'),
					fileCountEl: document.getElementById('fileCount'),
					startBtn: document.getElementById('startBtn'),
					clearBtn: document.getElementById('clearBtn'),
					addMoreBtn: document.getElementById('addMore'),
					logArea: document.getElementById('logArea'),
					dropZone: document.getElementById('dropZone'),
					uploadSection: document.getElementById('uploadSection'),
					filesSection: document.getElementById('filesSection'),
					modalOverlay: document.getElementById('modalOverlay'),
					fileListContainer: document.getElementById('fileListContainer'),
					settings: {
						num: document.getElementById('thresholdNum'),
						range: document.getElementById('thresholdRange'),
						scanMin: document.getElementById('scanMin'),
						scanMax: document.getElementById('scanMax'),
						ignoreTop: document.getElementById('ignoreTop'),
						ignoreBottom: document.getElementById('ignoreBottom'),
					},
					modals: {
						settings: document.getElementById('settingsModal'),
						help: document.getElementById('helpModal'),
						logs: document.getElementById('logsModal')
					}
				};

				let fileQueue = [];

				// --- å·¥å…·å‡½æ•° ---

				const log = (msg, type = 'info') => {
					const div = document.createElement('div');
					const colors = { error: 'text-red-400', success: 'text-green-400', info: 'text-slate-300' };
					div.className = `log-entry py-1 border-b border-slate-800/50 ${colors[type] || colors.info}`;
					const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
					div.innerHTML = `<span class="opacity-50 mr-2">[${time}]</span>${msg}`;
					dom.logArea.appendChild(div);
					dom.logArea.scrollTop = dom.logArea.scrollHeight;
				};

				const toggleView = (hasFiles) => {
					dom.uploadSection.classList.toggle('hidden', hasFiles);
					dom.filesSection.classList.toggle('hidden', !hasFiles);
				};

				const toggleModal = (modalId, show) => {
					const modal = dom.modals[modalId] || document.getElementById(modalId);
					if (!modal) return;

					if (show) {
						dom.modalOverlay.classList.remove('hidden');
						dom.modalOverlay.style.display = 'flex'; // å¼ºåˆ¶ flex å¸ƒå±€
						// éœ€è¦ reflow è§¦å‘ transition
						void dom.modalOverlay.offsetWidth; 
						dom.modalOverlay.classList.remove('opacity-0');
						
						modal.classList.remove('hidden');
						modal.style.display = 'block';
						requestAnimationFrame(() => {
							modal.classList.remove('scale-95');
							modal.classList.add('scale-100');
						});
					} else {
						modal.classList.remove('scale-100');
						modal.classList.add('scale-95');
						dom.modalOverlay.classList.add('opacity-0');
						
						setTimeout(() => {
							modal.classList.add('hidden');
							modal.style.display = 'none';
							// æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ modal éƒ½å…³é—­äº†
							const anyVisible = Object.values(dom.modals).some(m => !m.classList.contains('hidden'));
							if (!anyVisible) {
								dom.modalOverlay.classList.add('hidden');
								dom.modalOverlay.style.display = 'none';
							}
						}, 300);
					}
				};

				// --- æ–‡ä»¶å¤„ç†é€»è¾‘ ---

				const updateFileList = () => {
					dom.fileCountEl.textContent = `${fileQueue.length}`;
					
					if (fileQueue.length === 0) {
						dom.fileListEl.innerHTML = '';
						return;
					}
					
					dom.fileListEl.innerHTML = fileQueue.map((file, idx) => `
						<li class="group bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-2.5 shadow-sm hover:shadow-md transition-all duration-200 flex items-center justify-between gap-3 animate-fadeIn">
							<div class="flex items-center gap-3 overflow-hidden">
								<div class="w-9 h-9 rounded-lg bg-rose-50 dark:bg-rose-900/30 text-rose-500 dark:text-rose-400 flex items-center justify-center flex-shrink-0">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
										<path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 0 0 3 3.5v13A1.5 1.5 0 0 0 4.5 18h11a1.5 1.5 0 0 0 1.5-1.5V7.621a1.5 1.5 0 0 0-.44-1.06l-4.12-4.122A1.5 1.5 0 0 0 11.378 2H4.5Zm2.25 8.5a.75.75 0 0 0 0 1.5h6.5a.75.75 0 0 0 0-1.5h-6.5Zm0 3a.75.75 0 0 0 0 1.5h6.5a.75.75 0 0 0 0-1.5h-6.5Z" clip-rule="evenodd" />
									</svg>
								</div>
								<div class="min-w-0">
									<div class="font-medium text-slate-700 dark:text-slate-200 text-sm truncate" title="${file.name}">${file.name}</div>
									<div class="text-slate-400 dark:text-slate-500 text-xs flex items-center gap-2">
										<span>${(file.size / 1024 / 1024).toFixed(2)} MB</span>
										<span class="w-1 h-1 rounded-full bg-slate-300 dark:bg-slate-600"></span>
										<span class="text-indigo-500">ç­‰å¾…å¤„ç†</span>
									</div>
								</div>
							</div>
							<button data-index="${idx}" class="delete-btn p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors" title="ç§»é™¤æ–‡ä»¶">
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 pointer-events-none">
									<path d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z" />
								</svg>
							</button>
						</li>
					`).join('');
					
					dom.fileListContainer.scrollTop = dom.fileListContainer.scrollHeight;
				};

				const handleFiles = (files) => {
					const newFiles = Array.from(files).filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));
					if(newFiles.length === 0 && files.length > 0) {
						log('è¯·é€‰æ‹©PDFæ–‡ä»¶', 'error');
						return;
					}
					
					newFiles.forEach(f => {
						if(!fileQueue.some(ex => ex.name === f.name && ex.size === f.size)) {
							fileQueue.push(f);
						}
					});
					
					updateFileList();
					if (fileQueue.length > 0) toggleView(true);
				};

				// --- æ ¸å¿ƒç®—æ³• ---

				// æŸ¥æ‰¾ä¸­ç¼åˆ†å‰²ç‚¹
				const findSplitRatio = (ctx, width, height, cfg) => {
					const data = ctx.getImageData(0, 0, width, height).data;
					const xStart = Math.floor(width * cfg.scanMin);
					const xEnd = Math.floor(width * cfg.scanMax);
					const yStart = Math.floor(height * cfg.ignoreTop);
					const yEnd = Math.floor(height * (1 - cfg.ignoreBottom));
					
					const gaps = [];

					// æ‰«ææ¯ä¸€åˆ—ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºç©ºç™½åˆ—
					for(let x = xStart; x < xEnd; x++) {
						let whiteCount = 0;
						let totalPixels = 0;
						for(let y = yStart; y < yEnd; y++) {
							const i = (y * width + x) * 4;
							const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
							if (brightness > cfg.threshold) whiteCount++;
							totalPixels++;
						}
						gaps.push((whiteCount / totalPixels) > 0.98);
					}

					// å¯»æ‰¾æœ€é•¿è¿ç»­ç©ºç™½åŒºåŸŸ
					let maxLen = 0, maxStart = 0, currentStart = -1;
					for(let i = 0; i < gaps.length; i++) {
						if(gaps[i]) { 
							if(currentStart === -1) currentStart = i; 
						} else if(currentStart !== -1) {
							if(i - currentStart > maxLen) { 
								maxLen = i - currentStart; 
								maxStart = currentStart; 
							}
							currentStart = -1;
						}
					}
					// æ£€æŸ¥å°¾éƒ¨
					if(currentStart !== -1 && gaps.length - currentStart > maxLen) { 
						maxLen = gaps.length - currentStart; 
						maxStart = currentStart; 
					}

					// è¿”å›ä¸­ç¼ä¸­å¿ƒï¼Œé»˜è®¤ 0.5
					return maxLen === 0 ? 0.5 : (xStart + maxStart + maxLen / 2) / width;
				};

				const processFiles = async () => {
					if (fileQueue.length === 0) return;

					const config = {
						threshold: parseInt(dom.settings.num.value),
						scanMin: parseInt(dom.settings.scanMin.value) / 100,
						scanMax: parseInt(dom.settings.scanMax.value) / 100,
						ignoreTop: parseInt(dom.settings.ignoreTop.value) / 100,
						ignoreBottom: parseInt(dom.settings.ignoreBottom.value) / 100
					};

					dom.startBtn.disabled = true;
					dom.startBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>å¤„ç†ä¸­...`;
					
					toggleModal('logs', true);
					log('å¼€å§‹å¤„ç†ä»»åŠ¡...', 'info');

					const zip = new JSZip();
					let successCount = 0;

					try {
						for (const file of fileQueue) {
							log(`æ­£åœ¨åˆ†æ: ${file.name}`);
							try {
								const arrayBuffer = await file.arrayBuffer();
								const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
								const newPdfDoc = await PDFLib.PDFDocument.create();
								const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
								const pdfAnalysis = await loadingTask.promise;
								const pageCount = pdfDoc.getPageCount();

								for (let p = 0; p < pageCount; p++) {
									const page = await pdfAnalysis.getPage(p + 1);
									const viewport = page.getViewport({scale: 0.5});
									const canvas = document.createElement('canvas');
									const ctx = canvas.getContext('2d');
									canvas.width = viewport.width;
									canvas.height = viewport.height;
									await page.render({canvasContext: ctx, viewport: viewport}).promise;
									
									const splitRatio = findSplitRatio(ctx, canvas.width, canvas.height, config);
									
									// å¤åˆ¶é¡µé¢å¹¶è£å‰ª
									const [orig] = await newPdfDoc.copyPages(pdfDoc, [p]);
									const { width, height } = orig.getSize();
									const splitX = width * splitRatio;

									const leftP = await newPdfDoc.addPage(orig);
									leftP.setCropBox(0, 0, splitX, height);
									
									// å†æ¬¡å¤åˆ¶ç”¨äºå³åŠéƒ¨åˆ†ï¼ˆç¡®ä¿å¯¹è±¡ç‹¬ç«‹ï¼‰
									const [rightRaw] = await newPdfDoc.copyPages(pdfDoc, [p]);
									const rightP = await newPdfDoc.addPage(rightRaw);
									rightP.setCropBox(splitX, 0, width - splitX, height);
								}
								
								const newBytes = await newPdfDoc.save();
								zip.file(file.name.replace(/\.pdf$/i, '') + '_A4ç‰ˆ.pdf', newBytes);
								successCount++;
								log(`âœ… å®Œæˆ`, 'success');
							} catch (err) {
								console.error(err);
								log(`âŒ å¤±è´¥: ${err.message}`, 'error');
							}
						}

						if(successCount > 0) {
							log(`æ­£åœ¨æ‰“åŒ…ä¸‹è½½...`, 'success');
							const content = await zip.generateAsync({type:"blob"});
							const downloadUrl = URL.createObjectURL(content);
							const downloadLink = document.createElement('a');
							downloadLink.href = downloadUrl;
							downloadLink.download = "A3æ™ºèƒ½åˆ‡åˆ†A4ç»“æœ.zip";
							document.body.appendChild(downloadLink);
							downloadLink.click();
							document.body.removeChild(downloadLink);
							URL.revokeObjectURL(downloadUrl);
						}
					} catch (e) { 
						log(`ç³»ç»Ÿé”™è¯¯: ${e.message}`, 'error'); 
					} finally {
						dom.startBtn.disabled = false;
						dom.startBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M10 2a.75.75 0 0 1 .75.75v12.59l1.95-2.1a.75.75 0 1 1 1.1 1.02l-3.25 3.5a.75.75 0 0 0-1.1 0l-3.25-3.5a.75.75 0 1 1 1.1-1.02l1.95 2.1V2.75A.75.75 0 0 1 10 2Z" /></svg><span>å¼€å§‹å¤„ç†</span>`;
						log(`ä»»åŠ¡ç»“æŸï¼Œå…±å¤„ç† ${successCount} ä¸ªæ–‡ä»¶`, 'success');
					}
				};

				// --- äº‹ä»¶ç›‘å¬ç»‘å®š ---

				// æ‹–æ‹½ä¸Šä¼ 
				['dragover', 'dragleave', 'drop'].forEach(eventName => {
					dom.dropZone.addEventListener(eventName, (e) => {
						e.preventDefault();
						if (eventName === 'dragover') {
							dom.dropZone.classList.add('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/20');
						} else {
							dom.dropZone.classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/20');
						}
						if (eventName === 'drop') handleFiles(e.dataTransfer.files);
					});
				});

				dom.dropZone.addEventListener('click', () => dom.fileInput.click());
				dom.addMoreBtn.addEventListener('click', () => dom.fileInput.click());
				dom.fileInput.addEventListener('change', (e) => {
					handleFiles(e.target.files);
					dom.fileInput.value = ''; // é‡ç½® input ä»¥å…è®¸é‡å¤ä¸Šä¼ ç›¸åŒæ–‡ä»¶
				});

				// æ–‡ä»¶åˆ—è¡¨æ“ä½œï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
				dom.fileListEl.addEventListener('click', (e) => {
					const btn = e.target.closest('.delete-btn');
					if (btn) {
						const index = parseInt(btn.dataset.index);
						fileQueue.splice(index, 1);
						updateFileList();
						if (fileQueue.length === 0) toggleView(false);
					}
				});

				dom.clearBtn.addEventListener('click', () => {
					fileQueue = [];
					updateFileList();
					toggleView(false);
					log('åˆ—è¡¨å·²æ¸…ç©º', 'info');
				});

				// æ¨¡æ€æ¡†è§¦å‘å™¨
				document.getElementById('settingsBtn').addEventListener('click', () => toggleModal('settings', true));
				document.getElementById('helpBtn').addEventListener('click', () => toggleModal('help', true));
				document.getElementById('logsBtn').addEventListener('click', () => toggleModal('logs', true));

				// æ¨¡æ€æ¡†å…³é—­ï¼ˆå§”æ‰˜ï¼‰
				document.body.addEventListener('click', (e) => {
					// å…³é—­æŒ‰é’®
					const closeBtn = e.target.closest('[data-close]');
					if (closeBtn) {
						toggleModal(closeBtn.dataset.close, false);
						return;
					}
					// ç‚¹å‡»é®ç½©å±‚
					if (e.target === dom.modalOverlay) {
						Object.keys(dom.modals).forEach(k => toggleModal(k, false));
					}
				});

				// è®¾ç½®å‚æ•°è”åŠ¨
				dom.settings.range.addEventListener('input', (e) => dom.settings.num.value = e.target.value);
				dom.settings.num.addEventListener('change', (e) => dom.settings.range.value = e.target.value);

				// å¼€å§‹å¤„ç†
				dom.startBtn.addEventListener('click', processFiles);
			});
		</script>
		
		<style>
			/* æ»‘å—æ ·å¼ä¼˜åŒ– */
			.slider-thumb::-webkit-slider-thumb {
				appearance: none;
				height: 1.25rem;
				width: 1.25rem;
				border-radius: 50%;
				background: #4f46e5;
				cursor: pointer;
				box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
				transition: all 0.2s ease;
			}
			
			.slider-thumb::-webkit-slider-thumb:hover {
				transform: scale(1.1);
				box-shadow: 0 0 0 6px rgba(79, 70, 229, 0.2);
			}
			
			/* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
			.custom-scrollbar::-webkit-scrollbar {
				width: 4px;
			}
			.custom-scrollbar::-webkit-scrollbar-track {
				background: transparent;
			}
			.custom-scrollbar::-webkit-scrollbar-thumb {
				background-color: rgba(148, 163, 184, 0.3);
				border-radius: 2px;
			}
			.dark .custom-scrollbar::-webkit-scrollbar-thumb {
				background-color: rgba(71, 85, 105, 0.5);
			}
			.custom-scrollbar::-webkit-scrollbar-thumb:hover {
				background-color: rgba(148, 163, 184, 0.5);
			}
			
			/* åŠ¨ç”» */
			@keyframes fadeIn {
				from { opacity: 0; transform: translateY(5px); }
				to { opacity: 1; transform: translateY(0); }
			}
			.animate-fadeIn {
				animation: fadeIn 0.3s ease-out forwards;
			}
		</style>
	</body>
</html>